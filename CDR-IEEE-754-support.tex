%%%% -*- Mode: LaTeX -*-

%%%% CDR-IEEE-754-support.tex --
%%%% Minimalistic support for (a subset) of IEEE 754 for Common Lisp.


\documentclass[10pt,fleqn]{article}

\usepackage{latexsym}
\usepackage{epsfig}
\usepackage{alltt}
\usepackage{tabularx}
\usepackage{color}
\usepackage[margin=4cm]{geometry}

% \usepackage[OT1]{fontenc}
% \usepackage{bold-extra}
% \renewcommand{\ttdefault}{cmt}

\usepackage{lmodern}            % This works for decent bold 'tt'.


\newcommand{\tm}{$^\mathsf{tm}$}
\newcommand{\cfr}{\emph{cfr.}}

\newcommand{\Lisp}{\textsf{Lisp}}
\newcommand{\CL}{\textsf{Common~Lisp}}
\newcommand{\CLang}{\textsf{C}}
\newcommand{\Java}{\textsc{Java}}

\newcommand{\checkcite}[1]{{\textbf{[Missing Citation: #1]}}}
\newcommand{\checkref}[1]{{\textbf{[Missing Reference: #1]}}}

\newcommand{\missingpart}[1]{{\ }\vspace{2mm}\\
{\textbf{[Still Missing: #1]}}\\
\vspace{2mm}}

\newcommand{\marginnote}[1]{%
\marginpar{\begin{small}\begin{em}
{\raggedright #1}
\end{em}\end{small}}}

\newcommand{\undecided}[2]{%
  \vspace*{3mm}\noindent\fbox{\textbf{TBD: #1}{\ }\newline
    \begin{em}#2\end{em}}}



%%% CL 

\newcommand{\code}[1]{\texttt{#1}}

\newcommand{\term}[1]{\texttt{#1}}
\newcommand{\nonterm}[1]{\textit{$<$#1$>$}}


\newcommand{\kwd}[1]{\texttt{:#1}}

\newcommand{\varname}[1]{\textit{#1}}

\newcommand{\codeprompt}[1]{\textcolor{blue}{\textbf{#1}}}


%%% ANSI-Spec Like Macros.

% \newcommand{\DDictionaryItem}[1]{\subsection{#1}\vspace*{-9pt}\hrulefill}
\newcommand{\DDictionaryItem}[1]{\vspace*{6pt}\noindent\hrulefill\vspace*{-9pt}\subsection*{#1}}

\newcommand{\DSyntax}{\subsubsection*{Syntax:}}
\newcommand{\DSupertypes}{\subsubsection*{Supertypes:}}
\newcommand{\DArgsNValues}{\subsubsection*{Arguments and Values:}}
\newcommand{\DDescription}{\subsubsection*{Description:}}
\newcommand{\DExamples}{\subsubsection*{Examples:}}
\newcommand{\DExceptional}{\subsubsection*{Exceptional Situations:}}
\newcommand{\DNotes}{\subsubsection*{Notes:}}
\newcommand{\DSeeAlso}{\subsubsection*{See Also:}}



%%%% Document Title.


\title{
\LARGE{\bfseries Minimalistic Support for (a subset of) IEEE~745 in \CL{}}}

% \author{
% Marco Antoniotti\\
% Dipartimento di Informatica, Sistemistica e Comunicazione\\
% Universit\`{a} degli Studi di Milano Bicocca\\
% Viale Sarca 336, U14, Milan (MI), \textsc{Italy}\\
% \vspace{2mm}
% \texttt{mantoniotti} at \texttt{common-lisp.net},
% \texttt{marco.antoniotti} at \texttt{unimib.it}}

\author{TBD}

%\date{}


%\includeonly{}

\begin{document}

\maketitle

\begin{abstract}
This document presents a set of names and functions that aim at
providing a common ground for the support of (a subset of) IEEE~754 in
\CL{}.

The set of names and functions (and ancillary information) is intented
to be minimalistic; essentially for IEEE~754 constants (e.g.,
\code{NaN}) and some functionalities that are needed to control
floating point computations.
\end{abstract}


\section{Introduction}

The ANSI \CL{} Specification \cite{ANSIHyperSpec} hints at possible
compliance with IEEE ``Floating Points'' (in retrospect, IEEE~754) in
the description of the \code{*features*} variable, where:
\begin{description}
\item[\code{:ieee-floating-point}]
  If present, indicates that the
  implementation \emph{purports to conform}  to the requirements of
  \emph{IEEE Standard for Binary Floating-Point Arithmetic}. 
\end{description}

\noindent
Alas, the actual state of ``compliance'' among different
implementations varies wildly, with some implementations publicizing
the \code{:ieee-floating-point} feature while providing an unclear
subset of features\footnote{We talk of the sin and not of the sinner;
  you can check for yourself what happens in the various
  implementations.}.  This is in contrast with the current state of
affairs in other languages and languages ecosystems; especially
languages designed and built \emph{after} the publication of IEEE~754.

\vspace*{3mm}

The goal of this document is to address some of this state of affairs
by providing a specification for a minimalistic subset of
names,\marginnote{Not very ``minimalistic'' anymore\ldots}
functions and macros to be used in conjunction with IEEE~754
concepts.  Two issues especially will 
be addressed:
\begin{itemize}
\item Names for \code{NaN}s and ``infinities''.
\item Functions and macros to handle \emph{rounding modes}; with
  special care devoted to incentivate non-invasive, yet informative,
  implementations.
\end{itemize}

\vspace*{3mm}

Most of the content of this document borrows ideas from
\cite{IEEE-754}, \cite{C18}, and the documentation of
several \CL{} implementations.


\subsection{Impact on Current \CL{} Implementations}

It is understood that different \CL{} implementations already have
made some assumptions about the \emph{floating point environment} they
are dealing with.  In particular, the implementation of several \CL{}
math functions may be sensitive (or totally insensitive) to the
setting of \emph{rounding modes}.  E.g., it is quite possible that all
\CL{} implementations quietly assume a \emph{round to nearest} mode in
the implementation of the \CL{} standard floating point operations.
Another example is the treatment of comparison operators with respect
to NaNs, as depicted by the example below\footnote{There are ways to
  tell SBCL how to construct a NaN.}.

\vspace*{3mm}

\noindent
SBCL signals a \code{CL:FLOATING-POINT-INEXACT} condition on a
comparison involving \emph{quiet} NaNs.
\begin{alltt}
SBCL> \codeprompt{(< 42 quiet-nan)}
debugger invoked on a FLOATING-POINT-INEXACT:
  arithmetic error FLOATING-POINT-INEXACT signalled

Type HELP for debugger help, or (SB-EXT:EXIT) to exit from SBCL.

restarts (invokable by number or by possibly-abbreviated name):
  0: [ABORT] Exit debugger, returning to top level.

(SB-KERNEL:TWO-ARG-< 42 #<DOUBLE-FLOAT quiet NaN>)
SBCL 0]
\end{alltt}

\vspace*{3mm}

\noindent
Lispworks just returns \code{NIL}.
\begin{alltt}
LW> \codeprompt{(< 42 1D+-0)} \textcolor{red}{; LW uses this notation to denote NaNs.}
\textit{NIL}
\end{alltt}

\vspace*{3mm}

\noindent
CCL signals a \code{CL:FLOATING-POINT-INVALID-OPERATION} condition on a
comparison involving NaNs; but in this case it is unknown whether
\code{1D+-0} represents a \emph{quiet} or \emph{signalling} NaN.
\begin{alltt}
CCL> \codeprompt{(< 42 1D+-0)} \textcolor{red}{; CCL uses a notation similar to LW.}
> Error: FLOATING-POINT-INVALID-OPERATION detected
> While executing: CCL::FIXNUM-DFLOAT-COMPARE, in process Listener(4).
> Type cmd-. to abort, cmd-\ for a list of available restarts.
> Type :? for other options.
CCL 1 > 
\end{alltt}

As a consequence, this specification takes care not to impose
constraints on programs already running, or to require implementations to
actually adapt their cores to make the \CL{} package math functions in
order to comply.

Therefore, in order to be self-contained, this specification provides
facilities (described below) that allow a \CL{} programmer to actually
decide how to use IEEE~754 compliant code.  Most important, and
possibly most annoying, this specification must define \emph{symbols}
that corresponds to (some of) the operations described in
\cite{IEEE-754}, in order to provide the programmer with some
certainty about the behavior of floating point operations.

All in all, this specification is grafting onto the \CL{}
specification some functionality which was fully defined after the
publication of \cite{ANSIHyperSpec}.



\section{Description}

The IEEE~754 standard introduces a number of ``names'' for certain
special values: \code{NaN}s and infinities, as an example.  Several
\CL{} implementations provide such concepts, alas, not in a consensual
way.  The goal of this document is to provide such a minimal
consensus.

\subsection{\code{CL-MATH-IEEE-2019} Package}
\label{sect:package}

The implementations of this specification will provide a package named
(or nicknamed) \code{CL-MATH-IEEE-2019}.  All the symbols named in the rest
of the document are \code{export}ed from the above mentioned package.



\undecided{Features or APIs?}{Should \emph{features} or \emph{APIs} be
  provided to allow selective checks of this specification?}


\section{IEEE~754 \CL{}-related Dictionary}

\subsection{Floats, Infinities and NaNs}

\DDictionaryItem{Function \code{make-float}}

\DSyntax{}

\code{make-float} \varname{bytes} \code{\&optional}
\varname{float-type}
$\Rightarrow$ \varname{float}

\DArgsNValues{}

\varname{bytes} -- An integer or bit-vector representing the binary
pattern of a floating point number.\\
\varname{float-type} -- A recognizable subtype of \code{float},
defaulting to \code{*read-default-float-format*}.\\
\varname{result} -- the resulting floating point number or \code{NAN}.


\DDescription{}

The function constructs a floating point number of appropriate
\varname{float-type}, starting from the bit content of
\varname{bytes}.

If \varname{bytes} corresponds to the byte pattern of a \emph{NaN},
then a \code{NAN} is returned, regardless of \varname{float-type}.

\DExceptional{}

The function signals a \code{type-error} if either \varname{bytes} or
\varname{float-type} are not as described above.

\DSeeAlso{}

\code{NAN}.


\DNotes{}

This function is, in one form or another, already present in \CL{}
implementations.


\DDictionaryItem{Functions
  \code{make-short-float},
  \code{make-single-float},\\
  \code{make-double-float},
  \code{make-long-float}}

\DSyntax{}

\code{make-short-float} \varname{bytes}
$\Rightarrow$ \varname{result}\\
\code{make-single-float} \varname{bytes}
$\Rightarrow$ \varname{result}\\
\code{make-double-float} \varname{bytes}
$\Rightarrow$ \varname{result}\\
\code{make-long-float} \varname{bytes}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{bytes} -- An integer or bit-vector representing the binary
pattern of a floating point number.\\
\varname{result} -- the resulting floating point number or \code{NAN}.

\DDescription{}

The functions construct a floating point number of appropriate
float type starting from the bit content of
\varname{bytes}.

If \varname{bytes} corresponds to the byte pattern of a \emph{NaN},
then a \code{NAN} is returned.

The actual float type returned by the functions is the widest one
supported by the implementation; i.e., a call to
\code{make-long-float} may return a \code{double-float}.

\DExceptional{}

The functions signals a \code{type-error} if \varname{bytes} is not of
the type described above

\DSeeAlso{}

\code{NAN}, \code{make-float}.

\DNotes{}

These functions are, in one form or another, already present in \CL{}
implementations.

Implementations may supply a larger set of these functions, e.g.,
\code{make-quad-float}.


\DDictionaryItem{Value \code{NAN}}

\subsubsection*{Value:}

An \emph{implementation-dependent value}.


\DDescription{}

The value \code{NAN} holds a representation of a ``not a number'' object.


\DExamples{}

The actual value of \code{NAN} varies from implementation to
implementation.  Here are two examples of how \code{NAN} can be
represented in two implementations:

\begin{alltt}
SBCL> \codeprompt{NAN}
\textit{#<DOUBLE-FLOAT quiet NaN>}
\textcolor{red}{;;; E.g., the result of (sb-kernel:make-double-float -524288 0)}
\end{alltt}

\begin{alltt}
LW> \codeprompt{NAN}
\textit{1D+-0} \textcolor{red}{#| 1D+-0 is double-float not-a-number |#}
\end{alltt}

\DNotes{}

\noindent
It is to be understood that testing for equality of two \code{NAN}s is
not meaningful.

\noindent
It is also understood that, \code{(numberp nan)} should return \code{T}.

\DSeeAlso{}

\code{is-nan, nanp}


\DDictionaryItem{Functions \code{is-nan}, \code{nanp}}

\DSyntax{}

\code{is-nan} \varname{x} $\Rightarrow$ \textit{boolean}\\
\code{nanp} \varname{x} $\Rightarrow$ \textit{boolean}

\DArgsNValues{}

\varname{x} -- any \CL{} object.

\DDescription{}

The function \code{is-nan} (respectively \code{nanp}) returns \code{T}
whenever \varname{x} is a (representation of an IEEE) NaN.  Otherwise
it returns \code{NIL}.


\subsubsection*{Example:}

\begin{alltt}
CL prompt> \codeprompt{(is-nan nan)}
\textit{T}

CL prompt> \codeprompt{(nanp nan)}
\textit{T}

CL prompt> \codeprompt{(is-nan 42)}
\textit{NIL}

CL prompt> \codeprompt{(is-nan "NaN")}
\textit{NIL}
\end{alltt}



\DDictionaryItem{Constant Variables\\
  \code{long-float-positive-infinity},
  \code{long-float-negative-infinity},\\
  \code{double-float-positive-infinity},
  \code{double-float-negative-infinity},\\
  \code{single-float-positive-infinity},
  \code{single-float-negative-infinity},\\
  \code{short-float-positive-infinity},
  \code{short-float-negative-infinity},\\
  \code{+infL0}, 
  \code{-infL0},
  \code{+infD0}, 
  \code{-infD0},
  \code{+infF0}, 
  \code{-infF0},
  \code{+infS0}, 
  \code{-infS0},
  }

\subsubsection*{Value:}

The value of each of these constants is
\emph{implementation-dependent}.


\DDescription{}

The value of each of these constants must conform with the format
(i.e., the floating point type) codified in the name.


\DExamples{}

\begin{alltt}
SBCL> \codeprompt{single-float-positive-infinity}
\textit{#.SB-EXT:SINGLE-FLOAT-POSITIVE-INFINITY}
\end{alltt}

\begin{alltt}
LW> \codeprompt{single-float-positive-infinity}
\textit{+1F++0} \textcolor{red}{#| +1F++0 is single-float plus-infinity |#}
\end{alltt}

\begin{alltt}
LW> \codeprompt{-infD0}
\textit{-1D++0} \textcolor{red}{#| -1D++0 is double-float plus-infinity |#}
\end{alltt}

\begin{alltt}
LW> \codeprompt{-infL0}
\textit{-1D++0} \textcolor{red}{#| -1D++0 is double-float plus-infinity |#}
\textcolor{red}{;;; Note that in this case the widest float representation
;;; available is DOUBLE-FLOAT.}
\end{alltt}


\DNotes{}

The ``short'' names and the ``long ones'' are completely equivalent.
A possible implementation would be the following:
\begin{alltt}
(define-symbol-macro -infD0 double-float-negative-infinity)
\end{alltt}


\DDictionaryItem{Functions \code{is-infinity}, \code{infinityp}}

\DSyntax{}

\code{is-infinity} \varname{x} $\Rightarrow$ \textit{boolean}\\
\code{infinityp} \varname{x} $\Rightarrow$ \textit{boolean}

\DArgsNValues{}

\varname{x} -- any \CL{} object.

\DDescription{}

The function \code{is-infinity} (respectively \code{infinityp}) returns \code{T}
whenever \varname{x} is a (representation of an IEEE) infinity.  Otherwise
it returns \code{NIL}.


\subsubsection*{Example:}

\begin{alltt}
CL prompt> \codeprompt{(is-infinity double-float-negative-infinity)}
\textit{T}

CL prompt> \codeprompt{(infinityp nan)}
\textit{NIL}

CL prompt> \codeprompt{(is-infinity 42)}
\textit{NIL}

CL prompt> \codeprompt{(is-infinity "NaN")}
\textit{NIL}
\end{alltt}



\subsection{Low Level Exception Handling}

The \CL{} ANSI Specification provides the following conditions that
may be raised by an implementation (in an \emph{implementation
  dependent} way) in conjunction with floating point operations.
\begin{description}
\item \code{floating-point-invalid-operation},
\item \code{floating-point-inexact},
\item \code{floating-point-overflow},
\item \code{floating-point-underflow}.
\end{description}
Of course, the condition \code{division-by-zero} may also be signaled
by floating point operations.


The following entries specify an interface similar the \CLang{} Library
interface to the \emph{Floating Point Environment} provided by
\verb|<fenv.h>| \cite{C18}.






\DDictionaryItem{Type \code{fpe-exception}}

\DSupertypes{}

\code{fpe-exception}, \ldots, \code{T}

\DDescription{}

The \code{fpe-exception} type is defined to be:
\begin{alltt}
(member :divide-by-zero
        :inexact
        :invalid
        :overflow
        :underflow)
\end{alltt}
The meaning of these values correspond to a the possible exceptions
supported by an implementation.

\DSeeAlso{}

\code{fpe-exceptions-set}, \code{+fpe-all-exceptions+}.


\DDictionaryItem{Type \code{fpe-exceptions-set}}

\DSupertypes{}

\code{fpe-exceptions-set}, \ldots, \code{T}.

\DDescription{}

Objects of this type have an \emph{implementation dependent}
representation. They represent sets of \code{fpe-exception} objects.

\DNotes{}

The actual implementation may be a \code{list} or an
\code{(unsigned-byte 8)}.  Users should not rely on a particular
underlying implementation.




\DDictionaryItem{Constant Value \code{+fpe-all-exceptions+}}

\subsubsection*{Value:}

A value of type \code{fpe-exception-set}.

\DDescription{}

The value \code{+fpe-all-exceptions+} holds a representation the set of
exceptions -- whose members are of type \code{fpe-exception} -- that
are supported by the implementation.


\DSeeAlso{}

\code{fpe-exception}, \code{fpe-exception-set},
\code{all-supported-exceptions-p},\\
\code{some-supported-exceptions-p},
\code{supported-exception-p}.


\DDictionaryItem{Functions \code{supported-exception-p},\\
  \code{all-supported-exceptions-p},
  \code{some-supported-exceptions-p}}

\DSyntax{}

\code{supported-exception-p}
\varname{exception} $\Rightarrow$ \textit{boolean}\\
\code{all-supported-exceptions-p} \code{\&rest}
\varname{exceptions} $\Rightarrow$ \textit{boolean}\\
\code{some-supported-exceptions-p} \code{\&rest}
\varname{exceptions} $\Rightarrow$ \textit{boolean}

\DArgsNValues{}

\varname{exception} -- a \CL{} object of type 
\code{fpe-exception}.\\
\varname{exceptions} -- a list of \CL{} objects each of type 
\code{fpe-exception}.


\DDescription{}

The functions returns a true value if the exceptions passed as
arguments are supported by the implementation.

The function \code{supported-exception-p} returns true if 
\varname{exception} is supported by the implementation, and \code{NIL}
otherwise.

The function \code{all-supported-exceptions-p} returns true if all the
elements in \varname{exceptions} are supported by the implementation,
and \code{NIL} otherwise.

The function \code{some-supported-exceptions-p} returns true if any the
elements in \varname{exceptions} is supported by the implementation,
and \code{NIL} otherwise.

\DExamples{}

\begin{alltt}
CL prompt> \codeprompt{(supported-exception-p :divide-by-zero)}
\textit{T} \textcolor{red}{; Or could be be NIL.}

CL prompt> \codeprompt{(some-supported-exceptions-p :divide-by-zero :inexact)}
\textit{T} \textcolor{red}{; Assuming the previous operation returned true.}

CL prompt> \codeprompt{(all-supported-exception-p :divide-by-zero :inexact)}
\textit{NIL} \textcolor{red}{; Or could be be T.}
\end{alltt}

\DExceptional{}

The functions signal a \code{type-error} if \varname{exception}
is not of type \code{fpe-exception} or if \varname{exceptions} contains
objects not of type \code{fpe-exception}.


\DDictionaryItem{fpe-test-exceptions}

\DSyntax{}

\code{fpe-test-exceptions} \code{\&rest} \varname{excps}
$\Rightarrow$ \varname{excp-set}

\DArgsNValues{}

\varname{excps} -- A list of \code{fpe-exception} items.\\
\varname{excp-set} -- An object of type \code{fpe-exception-set}.

\DDescription{}

The function tests which of the \varname{excps} is set (i.e., whether
the corresponding flag is set in the underlying floating point
environment) and returns an object of type \code{fpe-exception-set}
with the corresponding flag set.

\DExamples{}

The following example (adapted from \cite{C18}) shows how a piece of
code may decide how to \code{signal} either
\code{floating-point-invalid-operation} or
\code{floating-point-overflow} (cfr., \cite{ANSIHyperSpec}.)

\begin{alltt}
(let ((fpe-excps \textcolor{blue}{(fpe-test-exceptions :overflow :invalid)}))
   (when (fpe-check-exceptions :invalid)
     (signal 'cl:floating-point-invalid-operation))
   (when (fpe-check-exceptions :overflow)
     (signal 'cl:floating-point-overflow))
   )
\end{alltt}

\DNotes{}

The \code{fpe-test-exceptions} function accesses the current floating
point environment.  \CL{} implementations may have made different
choices about if, when, and how to signal the standard \CL{} floating
point conditions.  That is, the above example may or may not work in a
given \CL{} implementation, as the code that actually set the floating
environment exception flags may have already signalled either
\code{cl:floating-point-invalid-operation} or
\code{cl:floating-point-overflow}, and the some corresponding handling
code may have already cleared the flags.

\DSeeAlso{}

\code{fpe-exception}, \code{fpe-exception-set},
\code{fpe-check-exceptions},\\
\code{cl:floating-point-invalid-operation},
\code{cl:floating-point-overflow}.





\DDictionaryItem{fpe-check-exceptions}

\DSyntax{}

\code{fpe-check-exceptions} \varname{excp-set} \code{\&rest} \varname{excps}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{excp-set} -- An object of type \code{fpe-exception-set}\\
\varname{excps} -- A list of \code{fpe-exception} items.\\
\varname{result} -- A boolean.

\DDescription{}

The function checks whether \emph{all} of the \varname{excps} flags
are set in the \varname{excp-set} and returns a boolean indicating the
result.  If the \varname{excps} is empty, then the function returns
\code{NIL}.

\DExamples{}

The following example (adapted from \cite{C18}) shows how a piece of
code may decide how to \code{signal} either
\code{floating-point-invalid-operation} or
\code{floating-point-overflow} (cfr., \cite{ANSIHyperSpec}.)

\begin{alltt}
(let ((fpe-excps (fpe-test-exceptions :overflow :invalid)))
   (when \textcolor{blue}{(fpe-check-exceptions :invalid)}
     (signal 'cl:floating-point-invalid-operation))
   (when \textcolor{blue}{(fpe-check-exceptions :overflow)}
     (signal 'cl:floating-point-overflow))
   )
\end{alltt}

\DNotes{}

Note that the value returned when \varname{excps} is empty is nor what
\CL{} users may expect from a function that looks like a call to
\code{(and)}.

The notes about \code{fpe-test-exceptions} regarding the example above
apply also in the case of \code{fpe-check-exceptions}.



\DSeeAlso{}

\code{fpe-exception}, \code{fpe-exception-set},
\code{fpe-test-exceptions},\\
\code{cl:floating-point-invalid-operation},
\code{cl:floating-point-overflow}.








\subsection{Floating Point Environment}

The \CLang{} specification \cite{C18}, Section~7.6, defines the \emph{Floating
  Point Environment} for a \CLang{} implementation.  Various \CL{}
implementations provide access to the floating point environment, but
with a wide range of interfaces, which boils down tho the assumed
representation of the \CLang{} \code{fenv\_t} type, described in
\cite{C18}.

This specification describes an interface which should accomodate the
current -- at the tie of this writing -- treatment of the floating
point environment provided by various \CL{} implementations.


\DDictionaryItem{Type \code{floating-point-environment}}

\DSupertypes{}

\code{floating-point-environment}, \ldots, \code{T}

\DDescription{}

The actual \code{floating-point-environment} definition is
\emph{implementation dependent}.  The definition is used to specify
the type of arguments being used by the functions comprising the
interface.


\DDictionaryItem{Accessors \code{fpe-traps}, \code{fpe-rounding-mode},
  \code{fpe-current-exceptions}, \code{fpe-accrued-exceptions},
  \code{fpe-precision}, \code{fpe-fast-mode-p}}

\DSyntax{}

\code{fpe-traps} \varname{fpe} $\Rightarrow$ \varname{traps}\\
\code{fpe-rounding-mode} \varname{fpe} $\Rightarrow$ \varname{rounding-mode}\\
\code{fpe-current-exceptions} \varname{fpe} $\Rightarrow$ \varname{exceptions}\\
\code{fpe-accrued-exceptions} \varname{fpe} $\Rightarrow$ \varname{exceptions}\\
\code{fpe-precision} \varname{fpe} $\Rightarrow$ \varname{precision}\\
\code{fpe-fast-mode-p} \varname{fpe} $\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{fpe} -- An object of type \code{floating-point-environment}.\\
\varname{rounding-mode} -- A member of the type \code{rounding-mode}.\\
\varname{exceptions} -- An object of type \code{fpe-exception-set}.\\
\varname{precision} -- One of the one of the integers 24, 53 and 64.\\
\varname{result} -- A \emph{boolean}.

\DDescription{}

The ``accessors'' (readers -- functions) extract information from
\varname{fpe}.


\DNotes{}

See also Section~\ref{sect:rounding} (below.)

\DSeeAlso{}

\code{floating-point-environment}, \code{rounding-mode},
\code{fpe-exception-set}. 


\DDictionaryItem{Function \code{set-floating-point-environment}}

\DSyntax{}

\begin{tabbing}
\code{set-floating-point-environment} \= \code{\&key}\\
\>\varname{traps}\\
\>\varname{rounding-mode}\\
\>\varname{current-exceptions}\\
\>\varname{precision}\\
\>\code{\&allow-other-keys}\\
$\Rightarrow$ \varname{modes}
\end{tabbing}


\DArgsNValues{}

\varname{traps} -- A list of the exception conditions that should cause
traps.\\
\varname{rounding-mode} -- The rounding mode to use when the result is
not exact.\\
\varname{current-exceptions} -- The argument is used to set the current
set of exceptions.\\
\varname{precision} -- An integer.\\
\varname{modes} -- An a-list containing the current floating
point modes; the indicators are keywords.

\DDescription{}

This function sets options controlling the floating-point
hardware. If a keyword is not supplied, then the current value is
preserved.

The possible values for each of the keywords are the
following.

\begin{itemize}
\item \varname{traps} is a list that can contain the keywords
  \code{:underflow}, \code{:overflow}, \code{:inexact}, \code{:invalid},
  \code{:divide-by-zero}, and \code{:denormalized-operand}.

\item \varname{rounding-mode} is the rounding mode to use when the result is
  not exact; it can assume the values \code{:nearest},
  \code{:positive-infinity}, \code{:negative-infinity} and
  \code{:zero}.

\item \varname{current-exceptions} is used to set the exception flags. The
  main use is setting the accrued exceptions to \code{NIL} to clear
  them.

\item \varname{precision} can be one of the integers 24, 53 and 64, standing for
  the internal precision of the mantissa.
\end{itemize}

\DExamples{}

None.


\DNotes{}

None.


\DExceptional{}

The function can always result in a no-op if access to the underlying
hardware is not fully supported.  When this happens
\code{set-floating-point-environment} must issue a warning.


\DSeeAlso{}

\code{get-floating-point-environment}.


\DDictionaryItem{Function \code{get-floating-point-environment}}

\DSyntax{}

\code{get-floating-point-environment} \textit{$<$no arguments$>$}
$\Rightarrow$ \varname{modes}

\DArgsNValues{}

\varname{modes} --  An object of type \code{floating-point-environment}.


\DDescription{}

The function returns an a-list that represents the current state of
the floating point modes in use at the time.  The format of the
returned \varname{modes} a-list is such to be
usable as an \code{apply} last argument for
\code{set-floating-point-environment}.


\DExamples{}

\begin{alltt}
SBCL> \codeprompt{(get-floating-point-environment)}
\textit{(:TRAPS (:OVERFLOW :INVALID :DIVIDE-BY-ZERO)
 :ROUNDING-MODE :NEAREST
 :CURRENT-EXCEPTIONS (:INEXACT)
 :FAST-MODE NIL
 :PRECISION :53-BIT)}
\end{alltt}


\DSeeAlso{}

\code{set-floating-point-environment}.


\DDictionaryItem{Function \code{default-floating-point-environment}}

\DSyntax{}

\code{default-floating-point-environment} \textit{$<$no arguments$>$}
$\Rightarrow$ \varname{fpe}

\DArgsNValues{}

\varname{fpe} -- An object of type \code{floating-point-environment}.

\DDescription{}

The function returns an object of type
\code{floating-point-environment} that represents the \emph{default}
floating point environment in use by the implementation.

% The format of the returned \varname{fpe} a-list is such to be usable
% as an \code{apply} last argument for
% \code{set-floating-point-environment}.

\DExamples{}

\begin{alltt}
SBCL> \codeprompt{(default-floating-point-environment)}
\textit{(:TRAPS (:OVERFLOW :INVALID :DIVIDE-BY-ZERO)
 :ROUNDING-MODE :NEAREST
 :CURRENT-EXCEPTIONS (:INEXACT)
 :FAST-MODE NIL
 :PRECISION :53-BIT)}
\textcolor{red}{;;; The format of the result for SBCL is incidental.
;;; The fpe-* readers can be made to work with such representation.}
\end{alltt}

\DNotes{}

The function \code{default-floating-point-environment} should always return
the same (or \code{equalp}) value.

\DSeeAlso{}

\code{set-floating-point-environment}, \code{get-floating-point-environment}.


\newpage
\DDictionaryItem{Macro \code{with-floating-point-environment}}

\DSyntax{}

% \code{with-floating-point-environment} (\textit{\code{\&key}}
% \varname{traps}
% \varname{rounding-mode}
% \varname{current-exceptions}
% \varname{precision}
% \varname{\code{\&allow-other-keys}}) \code{\&body} \varname{body}
% $\Rightarrow$ \varname{results}

\begin{tabbing}
\code{with-floating-point-environment} \=(\=\code{\&key}\\
\>\>                                \varname{traps}\\
\>\>                                \varname{rounding-mode}\\
\>\>                                \varname{current-exceptions}\\
\>\>                                \varname{precision}\\
\>\>                                \code{\&allow-other-keys})\\
\> \code{\&body} \varname{body}\\
$\Rightarrow$ \varname{results}
\end{tabbing}




\DArgsNValues{}

\varname{traps} -- A list of the exception conditions that should cause
traps.\\
\varname{rounding-mode} -- The rounding mode to use when the result is
not exact.\\
\varname{current-exceptions} -- The argument is used to set the current
set of exceptions.\\
\varname{precision} -- An integer.\\
\varname{results} -- One or more \CL{} objects.


\DDescription{}

The \code{with-floating-point-environment} macro executes \varname{body} in a
an environment where the floating point modes are determined by the
values passed as arguments to the macro.  Upon termination (either
normal or exceptional) of the code in \varname{body} the floating
point modes are restored to those in effect before the execution of\\
\code{with-floating-point-environment}.

As for \code{set-floating-point-environment} the values that the arguments
can take are the following:

\begin{itemize}
\item \varname{traps} is a list that can contain the keywords
  \code{:underflow}, \code{:overflow}, \code{:inexact}, \code{:invalid},
  \code{:divide-by-zero}, and \code{:denormalized-operand}.

\item \varname{rounding-mode} is the rounding mode to use when the result is
  not exact; it can assume the values \code{:nearest},
  \code{:positive-infinity}, \code{:negative-infinity} and
  \code{:zero}.

\item \varname{current-exceptions} is used to set the exception flags. The
  main use is setting the accrued exceptions to \code{NIL} to clear
  them.

\item \varname{precision} can be one of the integers 24, 53 and 64,
  standing for the internal precision of the mantissa.
\end{itemize}



\noindent
\varname{results} is the value (or values) returned by \varname{body}.


\DNotes{}

When called with an empty arguments list,
\code{with-floating-point-environment} is a no-op and \varname{body}
is executed as-is.

\DExceptional{}

The macro \code{with-floating-point-environment} performs a minimal
code-walk of \varname{body} and if it finds some floating point
operation which potentially may not respect the changed environment as
described by the specified arguments, it then issues a warning.


\DSeeAlso{}

\code{get-floating-point-environment},
\code{set-floating-point-environment}\\
\code{with-rounding-mode}.



\subsection{Rounding}
\label{sect:rounding}

Having control over IEEE rounding modes is necessary to implement a
number of numerical algorithms and data structures. The following
entries provide access to the IEEE facilities.


\DDictionaryItem{Type \code{rounding-modes}}

\DSupertypes{}

\code{rounding-modes}, \ldots, \code{T}

\DDescription{}

The \code{rounding-modes} type is defined to be:
\begin{alltt}
(member :indeterminable
        :zero
        :nearest
        :positive-infinity
        :negative-infinity)
\end{alltt}
The meaning of these values correspond to a direction of floating
point rounding.


\DNotes{}

The keywords used correspond to the \CLang{} Library \cite{C18}
\textbf{\code{FLT\_ROUNDS}} values of:

\vspace*{3mm}

\begin{tabular}{rl}
  \textbf{\code{-1}} & indeterminable.\\
  \textbf{\code{0}}  & toward zero.\\
  \textbf{\code{1}}  & toward nearest.\\
  \textbf{\code{2}}  & toward positive infinity.\\
  \textbf{\code{3}}  & toward negative infinity.\\
\end{tabular}

\vspace*{3mm}

As per the \CLang{} Library standard, \CL{} implementations can extend the
type \code{rounding-modes} with other keywords representing
\emph{implementation dependent} rounding modes.


\DDictionaryItem{Function \code{get-rounding-mode}}

\DSyntax{}

\code{get-rounding-mode} \textit{$<$no arguments$>$}
$\Rightarrow$ \varname{rounding-mode}

\DArgsNValues{}

\varname{rounding-mode} -- a value of type \code{rounding-modes}.

\DDescription{}

The function returns the current rounding mode.  The value
\code{:indeterminate} is returned if such rounding mode cannot be
determined.

\DSeeAlso{}

 \code{rounding-modes}.


\DDictionaryItem{Function \code{set-rounding-mode}}

\DSyntax{}

\code{set-rounding-mode} \varname{rounding-mode}
$\Rightarrow$ \varname{result}, \varname{success}

\DArgsNValues{}

\varname{rounding-mode} -- a \code{rounding-mode}\\
\varname{result} -- a \code{rounding-mode}\\
\varname{success} -- a boolean


\DDescription{}

The function sets the rounding mode.  If the setting of the rounding
mode is succesful, then \varname{rounding-node} is returned as
\varname{result} and \varname{success} is \code{T}.  Otherwise, the
rounding mode before the the call is returned with \varname{success}
\code{NIL}.\marginnote{Should it instead signal an error?}


\DDictionaryItem{Macro \code{with-rounding-mode}}

\DSyntax{}

\code{with-rounding-mode} \code{(} \varname{rm} \code{)} \code{\&body}
\varname{body}\\
$\Rightarrow$ \varname{results}

\DArgsNValues{}

\varname{rm} -- An item of type \code{rounding-modes}.\\
\varname{body} -- An implicit \code{progn} of code.\\
\varname{results} -- The value (or values) returned by \varname{body}.

\DDescription{}

The code in \varname{body} is executed with a floating point
environment where the rounding mode is set to \varname{rm}.  The
previous rounding mode is saved before executing \varname{body} and it
is restored (as if using \code{unwind-protect}) upon exit.

\DExceptional{}

The macro \code{with-rounding-mode} performs a minimal code-walk of
\varname{body} and if it finds some floating point operation which
potentially may not respect the rounding mode \varname{rm} issues a
warning.
%
It is assumed that this warning will be raised at macro-expansion
time.

\DExamples{}

The following examples may be from two implementations behaving
differently with respect to their handling of rounding modes at the
\CL{} package level.

\begin{alltt}
CL(A) prompt> \codeprompt{(with-rounding-mode (:positive-infinity)
                  (cl:* 2 21.0))}
\textit{42.0}
\end{alltt}

\begin{alltt}
CL(B) prompt> \codeprompt{(with-rounding-mode (:positive-infinity)
                  (cl:* 2 21.0))}
\textcolor{red}{Warning:
the function CL:* may not respect the new rounding mode :POSITIVE-INFINITY.}
\textit{42.0}
\end{alltt}



\subsection{Floating Point IEEE~754 Respecting Operations}
\label{sect:fp-operations}

A \CL{} implementation or a \CL{} library implementing this
specification will provide the following \emph{non-computational
  operations} (to follow the language of Section~5 of \cite{IEEE-754})
alongside some \CL{} features to allow for read-time (cfr.,
\emph{translation-time}) evaluations.


\DDictionaryItem{Function \code{is-cdr-ieee-754-conformant}}

\DSyntax{}

\code{is-cdr-ieee-754-conformant} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.

\DDescription{}

This function returns a non-\code{NIL} value if the \CL{}
implementation or the \CL{} library implements the specification of
this document.

If this function returns non-\code{NIL}, so will
\code{is-cdr-ieee-745-constants-providing},
\code{is-cdr-ieee-754-environment-providing} and
\code{is-cdr-ieee-745-operation-providing}.

\DSeeAlso{}

\code{is-cdr-ieee-745-constants-providing},
\code{is-cdr-ieee-754-environment-providing} and
\code{is-cdr-ieee-745-operation-providing}.



\DNotes{}

\cite{IEEE-754} specifies two predicates \code{is754version1985} and
\code{is754version2008}, but they imply conformance to the full
IEEE~754 standard.



\DDictionaryItem{Function \code{is-cdr-ieee-745-constants-providing}}

\DSyntax{}

\code{is-cdr-ieee-745-constants-providing} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.

\DDescription{}

This function returns a non-\code{NIL} value if the \CL{}
implementation or the \CL{} library only provides the names of the
constants naming NaNs and infinities.


\DDictionaryItem{Function \code{is-cdr-ieee-745-environment-providing}}

\DSyntax{}

\code{is-cdr-ieee-745-environment-providing} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.

\DDescription{}

This function returns a non-\code{NIL} value if the \CL{}
implementation or the \CL{} library provides the operations for
accessing and manipulating floating point exceptions
\checkref{Sections references} and the floating
point environment.


\DDictionaryItem{Function \code{is-cdr-ieee-745-operation-providing}}

\DSyntax{}

\code{is-cdr-ieee-745-operation-providing} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.


\DDescription{}

This function returns a non-\code{NIL} value if the \CL{}
implementation or the \CL{} library provides separate implementations
of the \emph{computational operations} that do conform to the IEEE~754
mandated behavior.


\DDictionaryItem{Function \code{is-cl-using-cdr-ieee-745}}

\DSyntax{}

\code{is-cl-using-cdr-ieee-745} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.


\DDescription{}

This function returns a non-\code{NIL} value if the mathematical
operations in the ANSI \CL{} standard \cite{ANSIHyperSpec} respect the
IEEE~745 specification.

\DNotes{}

This is a stronger requirement than the
presence of the \code{ieee-floating-point} feature in
\code{*features*}.


\DDictionaryItem{Features \code{:cdr-ieee-745-constants-providing},\\
  \code{:cdr-ieee-745-environment-providing} and\\
  \code{:cdr-ieee-745-operation-providing}}

\DDescription{}

These features are present in the \code{*features*} list whenever the
corresponding function, \code{is-}\emph{feature} returns a
non-\code{NIL} value.

\subsubsection{Numeric Operations}

The following \CL{} operations, broken down according to the
classification in Section~12.1.1 of \cite{ANSIHyperSpec} are exported
form the \code{CL-MATH-IEEE-2019} package
(cfr.,~\ref{sect:package}).

If \code{is-cdr-ieee-754-operation-providing} returns non-\code{NIL}
(and the\\ \code{:cdr-ieee-754-operation-providing} is in
\code{*features*}, then the operations are also implemented, otherwise
each of them signal an ``not implemented'' error.

\paragraph{Arithmetic Operations} ~\\

\begin{tt}
  \begin{tabular}{lll}
    * & 1+ & gcd\\
    + & 1- & lcm\\
    - & incf & conjugate\\
    / & decf & {\ }\\
  \end{tabular}
\end{tt}




\paragraph{Exponential, Logarithms and Trigonometry Operations} ~\\

\begin{tt}
  \begin{tabular}{lll}
    abs & cos & signum\\
    acos &  cosh &  sin\\
    acosh & exp  &  sinh\\
    asin &  expt &  sqrt\\
    asinh & isqrt &  tan\\
    atan &  log &   tanh\\
    atanh & phase & \\
    cis & & \\
  \end{tabular}
\end{tt}

\vspace*{3mm}

\noindent
Note that the \code{pi} constant is not present in the above table, 
which corresponds to Figure~12-2 of \cite{ANSIHyperSpec}.


\paragraph{Numeric Comparison and Predicates} ~\\

\begin{tt}
  \begin{tabular}{lll}
    /= &  >= & \\
    < &   & plusp\\
    <= &  max & zerop\\
    = & min & \\
    > & minusp & \\
  \end{tabular}
\end{tt}

\vspace*{3mm}

\noindent
Note that the \code{evenp} and \code{oddp} functions are not present in the above table, 
which corresponds to Figure~12-3 of \cite{ANSIHyperSpec}.

\paragraph{Correspondances with IEEE-754.} The list of operations
recommended by \cite{IEEE-754} is more extensive than the list of
operations provided by \CL{} (cfr., Table~9.1 in \cite{IEEE-754}).
The tables referenced below provide correspondances for the \CL{} functions,
especially regarding the exceptions (conditions) that must be
signalled.

\begin{table}[h]
  \begin{tabularx}{\textwidth}{|X|X|X|X|X|}
    \hline
    \CL{} function & IEEE-745 function & Math function & Domain &
    Exceptions\\
    \hline\hline
    
  \end{tabularx}
\end{table}





\begin{thebibliography}{9}

\bibitem{IEEE-754}
  \textit{{IEEE} Standard for Floating-Point Arithmetic}, IEEE Std
  754$^{\mathrm{tm}}$-2008, IEEE Computer Society, 2008.
  
\bibitem{C18}
  \textit{Programming languages -- C},
  International Standard \emph{ISO/IEC 9899-2018}, 2018.
  
\bibitem{ANSIHyperSpec}
  \textit{The \CL{} Hyperspec},
  published online at\\
  \texttt{http://www.lisp.org/HyperSpec/FrontMatter/index.html}, 1994.

\end{thebibliography}


\appendix

\section{Copying and License}

This work may be distributed and/or modified under the conditions of
the \emph{LaTeX Project Public License} (LPPL), either version 1.3 of this license
or (at your option) any later version. The latest version of this
license is in \texttt{http://www.latex-project.org/lppl.txt} and version 1.3 or
later is part of all distributions of LaTeX version 2005/12/01 or
later.

\noindent
This work has the LPPL maintenance status `maintained'.

\noindent
The Current Maintainer of this work is Marco Antoniotti.

\end{document}

%%%% end of file --CDR-IEEE-754-support.tex --
