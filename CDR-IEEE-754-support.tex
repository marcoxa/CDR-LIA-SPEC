%%%% -*- Mode: LaTeX -*-

%%%% CDR-IEEE-754-support.tex --
%%%% Minimalistic support for (a subset) of IEEE 754 for Common Lisp.


\documentclass[10pt,fleqn]{article}

\usepackage{latexsym}
\usepackage{epsfig}
\usepackage{alltt}
\usepackage{tabulary}
\usepackage{color}

\usepackage[margin=3cm]{geometry}

% \usepackage[linktocpage=true]{hyperref} % Causes some problems.
\usepackage[depth=4]{bookmark}

\usepackage{makeidx}

% \usepackage[OT1]{fontenc}
% \usepackage{bold-extra}
% \renewcommand{\ttdefault}{cmt}

\usepackage{lmodern}            % This works for decent bold 'tt'.


\newcommand{\tm}{$^\mathsf{tm}$}
\newcommand{\cfr}{\emph{cfr.}}

\newcommand{\Lisp}{\textsf{Lisp}}
\newcommand{\CL}{\textsf{Common~Lisp}}

\newcommand{\CMUCL}{\textsf{CMUCL}}
\newcommand{\SBCL}{\textsf{SBCL}}
\newcommand{\CCL}{\textsf{CCL}}
\newcommand{\ACL}{\textsf{ACL}}
\newcommand{\ABCL}{\textsf{ABCL}}


\newcommand{\Quicklisp}{\textsf{Quicklisp}}

\newcommand{\CLang}{\textsf{C}}
\newcommand{\Java}{\textsc{\textsf{Java}}}
\newcommand{\Fortran}{\textsc{\textsf{Fortran}}}

\newcommand{\checkcite}[1]{{\textbf{[Missing Citation: #1]}}}
\newcommand{\checkref}[1]{{\textbf{[Missing Reference: #1]}}}

\newcommand{\missingpart}[1]{{\ }\vspace{2mm}\\
{\textbf{[Still Missing: #1]}}\\
\vspace{2mm}}

\newcommand{\marginnote}[1]{%
\marginpar{\begin{small}\begin{em}
{\raggedright #1}
\end{em}\end{small}}}

\newcommand{\undecided}[2]{%
  \vspace*{3mm}\noindent\fbox{\textbf{TBD: #1}{\ }\newline\emph{#2}}}



%%% CL 

\newcommand{\code}[1]{\texttt{#1}}

\newcommand{\term}[1]{\texttt{#1}}
\newcommand{\nonterm}[1]{\textit{$<$#1$>$}}


\newcommand{\kwd}[1]{\texttt{:#1}}

\newcommand{\clieeeterm}[1]{\textit{#1}}
\newcommand{\clliaterm}[1]{\textit{#1}}

\newcommand{\varname}[1]{\textit{#1}}

\newcommand{\clterm}[1]{\textit{#1}}
\newcommand{\clname}[1]{\texttt{#1}}

\newcommand{\codeprompt}[1]{\textcolor{blue}{\textbf{#1}}}
\newcommand{\codelia}[1]{\textcolor{blue}{#1}}

\newcommand{\RArrow}{$\Rightarrow$}



%%% Useful Names.

\newcommand{\IEEEFPStd}{IEEE-754}
\newcommand{\IECFPStd}{IEC-60559}
\newcommand{\IECLIA}{ISO/IEC-10967}
\newcommand{\IECLIA123}{ISO/IEC-10967-1,2,3}


%%% ANSI-Spec Like Macros.

% \newcommand{\DDictionaryItem}[1]{\subsection{#1}\vspace*{-9pt}\hrulefill}
\newcommand{\DDictionaryItem}[1]{\vspace*{6pt}\noindent\hrulefill\vspace*{-9pt}\subsection*{#1}}

\newcommand{\DSyntax}{\subsubsection*{Syntax:}}
\newcommand{\DSupertypes}{\subsubsection*{Supertypes:}}
\newcommand{\DArgsNValues}{\subsubsection*{Arguments and Values:}}
\newcommand{\DDescription}{\subsubsection*{Description:}}
\newcommand{\DExamples}{\subsubsection*{Examples:}}
\newcommand{\DExceptional}{\subsubsection*{Exceptional Situations:}}
\newcommand{\DNotes}{\subsubsection*{Notes:}}
\newcommand{\DSeeAlso}{\subsubsection*{See Also:}}
\newcommand{\DValues}{\subsubsection*{Values:}}


%%% Spec special names.

\newcommand{\CLLIAPKG}{\code{CL-MATH-LIA-2020}}




%%%% Document Title.


\title{
\LARGE{\bfseries A Palimpsest of ``Language Independent Arithmetic'' in \CL{}}}

\author{
  Marco Antoniotti\\
  Dipartimento di Informatica, Sistemistica e Comunicazione\\
  Universit\`{a} degli Studi di Milano Bicocca\\
  Viale Sarca 336, U14, Milan (MI), \textsc{Italy}\\[2mm]
  \texttt{marco.antoniotti} at \texttt{unimib.it},\\
  \texttt{mantoniotti} at \texttt{common-lisp.net}}


% \author{TBD}

%\date{}


%\includeonly{}


\makeindex


\begin{document}

\maketitle


\begin{abstract}
  This document presents a set of names, functions and macros that aim
  at providing a common ground for the support of the \IEEEFPStd{}
  \cite{2008:IEEE-754} and of the \emph{Language Independent
    Arithmetic} (LIA) standards \cite{2012:LIA1,2001:LIA2,2004:LIA3}
  in \CL{}.

  The set of names and functions (and ancillary information) is
  intended to be minimalistic; essentially for \IEEEFPStd{} constants
  (e.g., \code{NaN}) and some functionalities that are needed to
  control floating point computations.
\end{abstract}

\newpage

\tableofcontents

\newpage

\section{Introduction}

The ANSI \CL{} Specification \cite{1996:ANSIHyperSpec} hints at possible
compliance with IEEE ``Floating Points'' (in retrospect, \IEEEFPStd{}) in
the description of the \code{*features*} variable, where:
\begin{description}
\item[\code{:ieee-floating-point}]
  If present, indicates that the
  implementation \emph{purports to conform}  to the requirements of
  \emph{IEEE Standard for Binary Floating-Point Arithmetic}. 
\end{description}

After the publication of the \CL{} standard \cite{1994:ANSICL}, other
standards were published by IEEE and ISO/IEC specifying the
Application Programming Interface (API) for, by then well established,
commonly used arithmetic and mathematical operations.  These
specifications are the \emph{IEEE Standard for Floating-Point
  Arithmetic} (\IEEEFPStd{}) \cite{2008:IEEE-754} specification (which
will be referred as \IEEEFPStd{} in this text) and the \emph{ISO/IEC
  Information technology -- Language independent arithmetic}
\cite{2012:LIA1,2001:LIA2,2004:LIA3} (in three parts, which will be
referred as LIA1, LIA2 and LIA3, or simply LIA, in this text).

\vspace*{3mm}

\noindent
The LIA specifications also contain Annexes specifying \emph{language
  bindings}, including \CL{} (cfr., LIA1, Annex~D).  They also specify
how a language definition should handle \emph{exceptional situations}
(cfr., LIA1, Section~6), which has consequences for \CL{} described
below.

\vspace*{3mm}

\noindent
Alas, the actual state of ``compliance'' with these specifications,
among different \CL{} implementations varies wildly, especially the
LIA ones, with some implementations publicizing the
\code{:ieee-floating-point} feature while providing an unclear subset
of functionalities of features\footnote{We speak of the sin and not of
  the sinner; you can check for yourself what happens in the various
  implementations.}.  This is in contrast with the current state of
affairs in other languages and language ecosystems; especially
languages designed and built \emph{after} the publication of the
\IEEEFPStd{} and LIA documents.

\vspace*{3mm}

The goal of this document is to address some of this state of affairs
by providing a specification for a minimalistic subset of
names,\marginnote{Not very ``minimalistic'' anymore\ldots}
functions and macros to be used in conjunction with \IEEEFPStd{}
concepts.  The following issues will especially 
be addressed:
\begin{itemize}
\item Names for \code{NaN}s and ``infinities''.
  
\item Functions and macros to handle with the underlying
  \emph{floating point environment} and the interplay between \IEEEFPStd{}
  notion of \emph{signaling} vs.~the \CL{} notion of
  \clterm{condition signal-ling}.
  
\item Functions and macros to handle \emph{rounding modes}; with
  special care devoted to incentivate non-invasive, yet informative,
  implementations.
  
\item Clarifying the behavior of the \CL{} set of mathematical
  functions (cfr.,~Section~12.2 of \cite{1996:ANSIHyperSpec}) with respect
  to the specification contained herein.

\item Providing a clear set of functionalities to handle
  \emph{exceptional situations} and a clear definition of the behavior
  of each operator and function with respect the \IEEEFPStd{} and LIA
  specifications.
\end{itemize}

\vspace*{3mm}

The content of this document borrows ideas from the \CLang{}
specification \cite{2018:C18}, and the documentation of
several \CL{} implementations.

\paragraph{Note.} In the following, the examples shown try to be
specific for a given implementation; that is, whenever a behavior is
referring to a specific implementation (even when illustrating a
generic behavior), the ``prompt'' will refer to that implementation --
\code{LW>}, \code{SBCL>}, etc. etc.


\subsection{Impact on Current \CL{} Implementations}

It is understood that different \CL{} implementations already have
made some assumptions about the \emph{floating point environment} they
are dealing with.  In particular, the implementation of several \CL{}
math functions may be sensitive to the
setting of \emph{rounding modes}.  E.g., it is quite possible that all
\CL{} implementations quietly assume a \emph{round to nearest} mode in
the implementation of the \CL{} standard floating point operations.
Another example is the treatment of comparison operators with respect
to NaNs, as depicted by the example below\footnote{There are ways to
  tell SBCL how to construct a NaN.}.

\vspace*{3mm}

\noindent
SBCL signals a \code{CL:FLOATING-POINT-INEXACT} condition on a
comparison involving \emph{quiet} NaNs.
\begin{alltt}
SBCL> \codeprompt{(< 42 quiet-nan)}
debugger invoked on a FLOATING-POINT-INEXACT:
  arithmetic error FLOATING-POINT-INEXACT signaled

Type HELP for debugger help, or (SB-EXT:EXIT) to exit from SBCL.

restarts (invokable by number or by possibly-abbreviated name):
  0: [ABORT] Exit debugger, returning to top level.

(SB-KERNEL:TWO-ARG-< 42 #<DOUBLE-FLOAT quiet NaN>)
SBCL 0]
\end{alltt}

\vspace*{3mm}

\noindent
Lispworks just returns \code{NIL}.
\begin{alltt}
LW> \codeprompt{(< 42 1D+-0)} \textcolor{red}{; LW uses this notation to denote NaNs.}
\textit{NIL}
\end{alltt}

\vspace*{3mm}

\noindent
CCL signals a \code{CL:FLOATING-POINT-INVALID-OPERATION} condition on a
comparison involving NaNs; but in this case it is unknown whether
\code{1D+-0} represents a \emph{quiet} or \emph{signaling} NaN.
\begin{alltt}
CL> \codeprompt{(< 42 1D+-0)} \textcolor{red}{; CCL uses a notation similar to LW.}
> Error: FLOATING-POINT-INVALID-OPERATION detected
> While executing: CCL::FIXNUM-DFLOAT-COMPARE, in process Listener(4).
> Type cmd-. to abort, cmd-\ for a list of available restarts.
> Type :? for other options.
CCL 1 > 
\end{alltt}

As a consequence, this specification takes care not to impose
constraints on programs already running, or to require implementations to
actually adapt their cores to make the \CL{} package math functions in
order to comply.

Therefore, in order to be self-contained, this specification provides
facilities (described below) that allow a \CL{} programmer to actually
decide how to use \IEEEFPStd{} compliant code.  Most important, and
possibly most annoying, this specification must define \emph{symbols}
that corresponds to (some of) the operations described in
\cite{2008:IEEE-754}, in order to provide the programmer with some
certainty about the behavior of floating point operations.

All in all, this specification is grafting onto the \CL{}
specification some functionality which was fully defined after the
publication of \cite{1996:ANSIHyperSpec}.


\newpage

\section{Description}

The \IEEEFPStd{} and LIA standards introduce a number of ``names'' for
certain special values: \code{NaN}s and infinities, as an example.
Several \CL{} implementations provide such concepts; alas, not in a
consensual way.  Moreover, the standards introduce ways to handle
\emph{exceptional situations}. At the time of this writing, the \CL{}
programmer does not have much control over \emph{how} to exploit the
richness of the specifications.

The goal of this document is to provide a minimal
consensus to give the \CL{} programmer ways to be able to work with
facilities in line with the \IEEEFPStd{} (\IECFPStd{}) and LIA
standards.  The specifications contained in this document are as
\textsf{common-lisp}-ish as possible, re-using as much the style and
naming conventions established in the ANSI~\CL{} Specification
\cite{1994:ANSICL,1996:ANSIHyperSpec}.



\subsection{\CLLIAPKG{} Package}
\label{sect:package}

The implementations of this specification will provide a package named
(or nicknamed) \CLLIAPKG{}.  All the symbols named in the rest
of the document are \code{export}ed from the above mentioned package.



\undecided{Features or APIs?}{Should \emph{features} or \emph{APIs} be
  provided to allow selective checks of this specification?}

\subsection{Floating Point Numbers}

This document contains a small number of simple facilities that appear
to be present in most \CL{} implementations or that are available as
libraries.  E.g., this document describes a \code{make-float} function
and a \code{parse-float} function, which has been available as a
separate library for quite some time in the community\footnote{The
  \code{parse-float} function and ancillary ones can be downloaded
  from \Quicklisp{} \cite{2008:Beane:Quicklisp}.}.


\subsection{Special Values}

This document provides specifications for \IEEEFPStd{}/\IECFPStd{}
\emph{special values} like \emph{infinities} (e.g.,
\code{single-float-positive-infinity}) and \emph{not-a-number}
(\code{NAN}).  This specification defines all these names.

\subsubsection{``Continuation'' and ``Exceptional'' Values}

The LIA specifications ensure that certain special values are passed
on as \emph{continuation} values downstream a computation.  This often
happens in conjunction with a \emph{notification}, that is, in
presence of an \emph{exceptional} situation (cfr.,
Section~\ref{sect:notifications}).

This specification clarifies when and \emph{how} such continuation
values are passed on -- the most common example being
\clieeeterm{quiet NaNs}.  This specification also clarifies when and
how \emph{exceptional values} are to be considered; also,
\clieeeterm{infinities} and \clieeeterm{NaN}s used as
\emph{continuation values} are not to be intended as exceptional
values (cfr., \cite{2012:LIA1} Section~4.2.3, 4.2.8, 4.2.9).



\subsection{Rounding Modes}

One of the functionalities described in \IEEEFPStd{} (\IECFPStd{}) and LIA is
the control of \emph{rounding modes}.  Rounding modes control is
important in some numerical applications and libraries.  E.g., they
are necessary to build \emph{interval arithmetic} libraries (cfr., \cite{hickey:interval:2001,kulisch:complete:2009,revol:introIEEEIA:2017}).

The \CLang{} standard interface for floating point rounding modes
control (cfr., \cite{2018:C18} Section~7.6.3) provides the \code{fgetround}
and \code{fsetround} functions that can get and set the rounding mode;
the rounding modes being defined as \code{FE\_DOWNWARD},
\code{FE\_TONEAREST},\\
\code{FE\_TOWARDZERO} and \code {FE\_UPWARD} (which are \CLang{}
macros).  In order to change the rounding mode of (floating point)
operations, a \CLang{} programmer invokes the \code{fsetround}
function manually establishing a new state of the processing
machinery.

Within \CL{}, a programmer expects a number of facilities to simplify
coding.  To this end, apart from the expected definition of a
\code{rounding-mode} type defined as
\begin{alltt}
(member :indeterminable
        :zero
        :nearest
        :positive-infinity
        :negative-infinity)
\end{alltt}
and of the corresponding \code{get-rounding-mode} and
\code{set-rounding-mode}, this document also defines the macros
\code{with-rounding-mode}, \code{round-to-zero}, \code{round-to-near},
\code{round-upward}, and \code{round-downward}.  Their intent use is
to localize and automate the establishing of a given rounding mode for
a piece of code.

\vspace*{3mm}

\noindent
As an example, consider the following code snippet:
\begin{alltt}
CL prompt> \codeprompt{(round-upward (* 2 21.0))}
\textit{42.0}
\end{alltt}
In this case the intent of the programmer is to ensure that the
rounding mode in effect while executing the multiplication is
\emph{toward positive infinity}.  Upon returning its value, the
\code{round-upward} macro, the rounding mode is reset to the value
before its invocation.

\subsubsection{Default Rounding Mode}

All \CL{} implementations appear to assume that the floating point
rounding mode is set to \emph{round to nearest}.  Hence this
specification states that the default rounding mode is set \emph{round
  to nearest}.

\subsubsection{Interaction with the \CL{} Reader}

The \CL{} reader builds floating point numbers according to the rules
specified in \cite{1994:ANSICL}.  This specification states that the
\CL{} reader subsystem is not affected by changes of the rounding
mode.  That is,
\begin{alltt}
CL prompt> \codeprompt{(round-upward (read))}
42.0
\textit{42.0}
\end{alltt}
will produce a \code{42.0} result that is rounded according to the
standard rules of the \CL{} reader floating point parsing
rules, overriding the \code{round-upward} settings.



\subsection{Notifications and Exception Handling}
\label{sect:notifications}

The floating point and complex arithmetic exceptional situation
handling machinery described in
\cite{2012:LIA1,2001:LIA2,2004:LIA3,2008:IEEE-754}, more specifically,
\cite{2012:LIA1} Section~6, \emph{Notification}.  Three main
notification modalities are described in LIA1:
\begin{itemize}
\item \emph{Notification by recording in indicators} (NRI -- LIA1,
  Section~6.2.1).
\item \emph{Notification by alteration of control flow} (NACF -- LIA1,
  Section~6.2.2).
\item \emph{Notification by termination with message} (NTM -- LIA1,
  Section~6.2.3).
\end{itemize}

\noindent
These notification machineries balance three viewpoints that different
engineers have.

\begin{itemize}
\item The hardware instruction set designer\footnote{Just a label; it
    is used for the purpose of illustration.}.
\item The programming language designer.
\item The specification implementor.
\end{itemize}

The \CL{} ANSI Specification provides the following conditions that
may be raised by an implementation (in an \emph{implementation
  dependent} way) in conjunction with floating point operations.
\begin{description}
\item \code{floating-point-invalid-operation},
\item \code{floating-point-inexact},
\item \code{floating-point-overflow},
\item \code{floating-point-underflow}.
\end{description}
Of course, the condition \code{division-by-zero} may also be signaled
by floating point operations.

The LIA1 specification, Annex~D, proposes that \CL{} defined the
arithmetic exception handling using the Condition System, i.e., using
the NACF notification approach.  This document specifies that
\textbf{both} alternatives NRI and NACF are actually available to the
programmer\footnote{\CMUCL{} and \SBCL{} already provide
  both modes, although in a non fully documented way. In fact:

\begin{alltt}
CMUCL> \codeprompt{(/ 42 0.0)}

Arithmetic error DIVISION-BY-ZERO signaled.
Operation was /, operands (42.0 0.0).
   [Condition of type DIVISION-BY-ZERO]

Restarts:
  0: [ABORT] Return to Top-Level.

Debug  (type H for help)
\end{alltt}
  The above is the behavior implied by LIA1 for \CL{}.  However,
  \CMUCL{} (and \SBCL{}) provide also direct manipulation of the
  underlying \emph{floating point environment}.  In that case, it
  appears that \CMUCL{} and \SBCL{} do offer the NRI machinery.
\begin{alltt}
SBCL> \codeprompt{(sb-int:with-float-traps-masked (:divide-by-zero) (/ 3 0.0))}
\textit{\#.SB-EXT:SINGLE-FLOAT-POSITIVE-INFINITY}

SBCL> \codeprompt{(sb-int:get-floating-point-modes)}\\
\textit{(:TRAPS (:OVERFLOW :INVALID :DIVIDE-BY-ZERO)\\
  :ROUNDING-MODE :NEAREST\\
  :CURRENT-EXCEPTION NIL\\
  :ACCRUED-EXCEPTION NIL\\
  :FAST-MODE NIL\\
  :PRECISION :53-BIT)}
\end{alltt}
In the case above, the division by zero is not raised or recorded and
the expected ``continuation value'' is returned (in this case the
\code{short-float} $\infty$).
}.
This causes issues in the interplay between the NRI and the NACF
exception handling methods, but it gives the programmer all the fine
control it is needed to handle many potential numerical
issues. Incidentally, note that LIA1 provides an example about how
\Fortran{} may provide some compiler directives to choose between NRI
and NTM (cfr., LIA1, Annex E).
\begin{alltt}
!LIA\$  NOTIFICATION=RECORDING
!LIA\$  NOTIFICATION=TERMINATE
\end{alltt}

In order to select and introspect what kind of exception handling
regime is selected in a given computation\footnote{In this
  specification, no mention of \emph{threading model} is made;
  however, it is assumed that an implementation can make all the
  dynamical behavior of numerical computations ``thread safe''.}, this
specification provides the following API.
\begin{itemize}
\item An enumerated type for NRI, NACF and NTM: %\\
  \code{arithmetic-notification-style}.
  \begin{alltt}
    (deftype \codelia{arithmetic-notification-style} ()
      (member :recording    \textcolor{red}{; I.e., NRI.}
              :error        \textcolor{red}{; I.e., NACF.}
              :termination  \textcolor{red}{; I.e., NTM.}
              ))
  \end{alltt}
\item A set of functions and macros to retrieve and set the current
  notification style.
  \begin{description}
  \item \code{current-notification-style}: a function that retrieves
    the, as the name implies, the current notification style.
  \item \code{set-notification-style}: a function that sets the
    notification style.
  \item \code{with-notification-style}: a macro that temporarily sets
    the notification style and ensures to restore the one in effect
    before its invocation.
  \end{description}
\item A ``mirroring'' in package \CLLIAPKG{} of the ANSI CL floating
  point exceptions in order to accommodate the notion of
  \emph{continuation values}.  This will amount to have the mirrored
  ANSI CL floating point exceptions have a \code{continuation-value}
  slot with a associated initarg and reader (of the same name).
\end{itemize}

\vspace*{2mm}

\noindent
Finally, the entries in Section~\ref{sect:fpe-dictionary} specify an interface
similar the \CLang{} Library interface to the \emph{Floating Point
  Environment} provided by \verb|<fenv.h>| \cite{2018:C18}.


\subsubsection{Interaction Between the ``Low Level'' \IEEEFPStd{} and LIA
  ``Signaling'' Machinery and \CL{} Condition Handling}

The \IEEEFPStd{} and LIA specifications (cfr., Section~7 of
\cite{2008:IEEE-754} and Sections~4.1.3, 4.1.4 and~6 of
\cite{2012:LIA1}) appear to imply that the actual handling of
``exceptional'' situations should follow the steps below.  Given an
operation $f(x, \ldots)$.

\begin{enumerate}
\item Check the arguments of $f$ for special cases regarding
  \clieeeterm{NaN}s and \clieeeterm{infinities}.
\item Decide whether a \clieeeterm{IEEE exception} should be
  \emph{signaled}.
  \begin{enumerate}
  \item Handle the exception \emph{by default}.
  \item Raise the flags to indicate what exception was signaled (and
    handled by default).
  \end{enumerate}
\end{enumerate}

The specifications also assume that the \emph{notification} of an
\emph{exceptional situation} should either be recorded ``somewhere''
(in the \CLang{} specification, Section~7.6, in an object of type
\code{fenv\_t}) and that ``catastrophic'' events should ensue from HW
traps and signals.

The LIA specifications indicate that a language \emph{may} provide
alternative modes of ``handling'' such exceptions, acknowledging the
presence of ``exception handling'' machinery in most modern languages
\missingpart{Reference to specs ``Alternate Exception Handling'' --
  LIA1, Section~6, Annex~D};
and \CL{} is not an exception, if not for the much richer set of
features that it provides with its ``Condition System''.  As a matter
of fact, LIA1 indicates that \CL{} should define such an ``alternate
exception handling'' based on the standard Condition System.

In the following, this specification will state exactly what kind of
behavior the various functions and macros will follow.  In general, a
\CL{} \emph{condition} will be \emph{signaled} when either the \CL{}
standard already mandates so (e.g., in the case of
\code{cl:division-by-zero}) or when the LIA specification implies that
the ``continuation value'' and the recording of the exception proposed
are really a stopgap measure\footnote{This may be seen as somewhat
  arbitrary.  This interpretation is warranted, as the main goal of
  the present document is to narrow down as much as possible
  alternative behaviors -- read: \emph{implementation dependent}
  ones. \textbf{This footnote may be inconsistent with LIA1, Annex~D,
    w.r.t., \CL{}.}}.

\subsubsection{Specialized Handling of LIA-related Exceptions}

This document specifies a simple macro, built on top of the standard
\CL{} condition handling machinery to quickly handle LIA-related
exceptions, that is, the standard \CL{} \code{floating-point-invalid-operation},
\code{floating-point-inexact},\\
\code{floating-point-overflow}, and
\code{floating-point-underflow} conditions.  This macro provides for
a simplified \clieeeterm{alternative exception handling}
\checkref{Alternative Exception Handling}.

The macro is named \code{trap-math} and has the following
simple syntax:
\begin{alltt}
  (trap-math (&key \textit{notify-by} \textit{before} \textit{after}) <\textit{expr}> <\textit{handler}>* )
\end{alltt}
In the simplest case \code{trap-math} is a no-op, with
respect to the behavior of the math operations in \code{<\textit{expr}>}.
\begin{alltt}
CL prompt> \codeprompt{(trap-math () (* 2 21.0))}
\textit{42.0}
\end{alltt}
\ldots but:
\begin{alltt}
LW prompt> \codeprompt{(trap-math () (/ 40 0.0))}

Error: Division-by-zero caused by / of (40.0 0.0).
  1 (continue) Return a value to use.
  2 Supply new arguments to use.
  3 (abort) Return to top loop level 0.

Type :b for backtrace or :c <option number> to proceed.
Type :bug-form "<subject>" for a bug report template or :? for other options.
\end{alltt}
On the other hand, the following example produces the LIA and \CLang{} result
(assuming that\\
\code{*read-default-float-format*} was \code{single-float}).
\begin{alltt}
CL prompt> \codeprompt{(trap-math () (/ 40 0.0)
               (division-by-zero () :continue))}
\textit{INFS}
\color{red}{;;; ... or \textit{1S++0}, or \textit{SINGLE-FLOAT-POSITIVE-INFINITY}.}
\end{alltt}
What the macro wants to convey is the fact that when
\code{division-by-zero} is caught (thus invoking the
\code{<\textit{handler}>} above), we can simply \emph{continue} with
the \emph{continuation value} that is associated to the operation that
actually signaled the condition; note that this may be different from
the usual \CL{} behavior -- \code{division-by-zero} a case in point.

The macro \code{try-math} also makes provisions to set a local \emph{notification
  style} (cfr., the keyword argument \textit{\code{style}} as per the
macro \code{with-notification-style}.

Other ``actions'' available, besides \code{:continue}, are
\begin{itemize}
\item\code{:default} the behavior of the operation that signaled
  the condition is the default one. In the example above, the
  \code{division-by-zero} condition is re-signaled, i.e., passed
  on, but for other operations it may be different; in most cases this
  will be a no-op with respect to the specification.
    
\item\code{:clear} the low level exceptions stored in the
  \emph{floating point environment} are cleared\footnote{Cfr.,
    the \CLang{} standard function \code{feclearexcept},
    Section~7.6.2.1 of \cite{2018:C18}.}.

\item\code{(:continue <\textit{expr}>)} the value(s) returned by
  \code{\textit{expr}} are used as \emph{continuation value(s)}.
\end{itemize}
The \code{:default} and the \code{:continue} forms (also the
\code{:continue} with ``values'') are mutually exclusive.  The effect
of \code{:clear} is described hereafter. See the full documentation of
the macro \code{trap-math} for more details.

\paragraph{LIA Exceptions in the Floating Point Environment.} Whenever
an exception ``happens'', the corresponding flag is \emph{raised}
(i.e., stored in the \emph{floating point environment} and remains
available for further analysis by the program; at least when using the
\CLang{} library, which has been the inspiration for this
specification.  In \CL{} some operations do signal a
\clterm{condition} which may or may not be handled by the program.
The choice of this specification is to state that the signaling of a
\CL{} condition, say \code{cl:division-by-zero} does also raise the
corresponding \clieeeterm{floating point exception flag}.  Moreover,
unless some special machinery is used (cfr., the
\code{trap-math} macro) the handling of a \CL{} condition
(say, \code{cl:floating-point-invalid-operation}) by
\code{handler-case} or similar facilities \emph{does not clear} the
floating point environment flags (unless done explicitly by the
handler code).

\missingpart{Should I have an argument for ``before'' and
  ``after'' operations in \code{trap-math}?  Like
  \code{:restore-on-exit} \code{:clear-on-exit} \code{clear-on-entry}
  \code{preserve-on-entry}}

\noindent
As an example consider the following code snippet.
\begin{alltt}
(defun boom (x)
    (declare (type single-float x))
    (handler-case 
        (/ x 0)
      (division-by-zero (e)
        (format *error-output* "Boom ~S.~%" e)))
\end{alltt}
After this function is run, the result will be \code{NIL} \emph{and} the
floating point environment will still have the \code{divZero} flag raised.
That is, the following interaction should be expected:
\begin{alltt}
CL prompt> \codeprompt{(boom 42.0s0)}

Boom #<Condition DIVISION-BY-ZERO>
\textit{NIL}

CL prompt> \codeprompt{(fpe-test-notifications :division-by-zero)}
\textit{T}
\end{alltt}


\newpage

\section{\IEEEFPStd{} and LIA \CL{}-related Dictionary}

\subsection{Integers}

%%% LIA1 requires some operations for "integers", but in CL there are
%%% "integers" and "fixnums".

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Constant \code{bounded-fixnum}}
\index{B!\code{bounded-fixnum}}

\DValues{}

The value is \code{T}.

\DDescription{}

This constant indicates that the \CL{} datatype \code{fixnum} is
bounded (with bounds \code{most-positive-fixnum} and
\code{most-negative-fixnum}).

\DNotes{}

This is the parameter \textit{bounded}$_I$ with $I$ equal to
\code{fixnum}, required in LIA1 \cite{2012:LIA1}.

\DSeeAlso{}

\code{bounded-integer},
%
\code{minimum-fixnum},
\code{most-negative-fixnum},\\
\code{maximum-fixnum},
\code{most-positive-fixnum},\\
%
\code{minimum-integer},
\code{maximum-integer}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Constant \code{bounded-integer}}
\index{B!\code{bounded-integer}}

\DValues{}

The value is \code{NIL}.

\DDescription{}

This constant indicates that the \CL{} datatype \code{integer} is
unbounded.

\DNotes{}

This is the parameter \textit{bounded}$_I$, with $I$ equal to
\code{integer} required in LIA1 \cite{2012:LIA1}.

\DSeeAlso{}

\code{bounded-fixnum},
%
\code{minimum-fixnum},
\code{most-negative-fixnum},\\
\code{maximum-fixnum},
\code{most-positive-fixnum},\\
%
\code{minimum-integer},
\code{maximum-integer}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Constant \code{has-infinity-fixnum}}
\index{H!\code{has-infinity-fixnum}}

\DValues{}

The value is \code{NIL}.

\DDescription{}

This constant indicates that the \CL{} datatype \code{fixnum} does not
include infinities.

\DNotes{}

This is the parameter \textit{hasinf}$_I$ with $I$ equal to
\code{fixnum}, required in LIA1 \cite{2012:LIA1}.

\DSeeAlso{}

\code{bounded-fixnum}, \code{bounded-integer}, \code{has-infinity-integer}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Constant \code{has-infinity-integer}}
\index{H!\code{has-infinity-integer}}

\DValues{}

The value is \code{NIL}.\marginnote{Or should it be \code{T}? In this
  case, there will be several consequences; how is an integer infinity
represented? What is the ``continuation value'' for a division by
zero?}

\DDescription{}

This constant indicates that the \CL{} datatype \code{integer} does not
include infinities.

\DNotes{}

This is the parameter \textit{hasinf}$_I$ with $I$ equal to
\code{integer}, required in LIA1 \cite{2012:LIA1}.

\DSeeAlso{}

\code{bounded-fixnum}, \code{bounded-integer}, \code{has-infinity-fixnum}.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Constants \code{minimum-fixnum}, \code{maximum-fixnum}}
\index{M!\code{minimum-fixnum}}
\index{M!\code{maximum-fixnum}}

\DValues{}

The value of \code{minimum-fixnum} is \code{cl:most-negative-fixnum}.\\
The value of \code{maximum-fixnum} is \code{cl:most-positive-fixnum}.

\DDescription{}

These constants represent the minimum and maximum \code{fixnum}s
available in an implementation.

\DNotes{}

These are the parameters \textit{minint}$_I$ and \textit{maxint}$_I$,
with $I$ equal to \code{fixnum}, required in LIA1 \cite{2012:LIA1}.
Their values are the obvious \CL{} counterparts.

\DSeeAlso{}

\code{bounded-fixnum},
\code{bounded-integer},\\
%
\code{most-negative-fixnum},\\
\code{most-positive-fixnum},\\
%
\code{minimum-integer},
\code{maximum-integer}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Constants \code{minimum-integer}, \code{maximum-integer}}
\index{M!\code{minimum-integer}}
\index{M!\code{maximum-integer}}

\DValues{}

The value of \code{minimum-integer} is $-\infty$.\\
The value of \code{maximum-integer} is $+\infty$\marginnote{The values
  are, for the time being, arbitrary.  They could be made equal to the
  floating point infinities, with all the necessary consequences.}

\DDescription{}

These constants represent the minimum and maximum \code{integers},
which are usually limited by actual memory constraints.

\DNotes{}

These are the parameters \textit{minint}$_I$ and \textit{maxint}$_I$,
with $I$ equal to \code{integer}, required in LIA1 \cite{2012:LIA1}.

\DSeeAlso{}

\code{bounded-fixnum},
\code{bounded-integer},\\
%
\code{minimum-fixnum},
\code{maximum-fixnum}.

\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Floats, Infinities and NaNs}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{make-float}}
\index{M!\code{make-float}}

\DSyntax{}

\code{make-float} \varname{bytes} \code{\&optional}
\varname{float-type}
$\Rightarrow$ \varname{float}

\DArgsNValues{}

\varname{bytes} -- An integer or bit-vector representing the binary
pattern of a floating point number.\\
\varname{float-type} -- A recognizable subtype of \code{float},
defaulting to \code{*read-default-float-format*}.\\
\varname{result} -- the resulting floating point number or \code{NAN}.


\DDescription{}

The function constructs a floating point number of appropriate
\varname{float-type}, starting from the bit content of
\varname{bytes}.

If \varname{bytes} corresponds to the byte pattern of a \emph{NaN},
then a \code{NAN} is returned, regardless of \varname{float-type}.

\DExceptional{}

The function signals a \code{type-error} if either \varname{bytes} or
\varname{float-type} are not as described above.

\DSeeAlso{}

\code{NAN}.

\DNotes{}

This function is, in one form or another, already present in \CL{}
implementations.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions
  \code{make-short-float},
  \code{make-single-float},\\
  \code{make-double-float},
  \code{make-long-float}}
\index{M!\code{make-short-float}}
\index{M!\code{make-single-float}}
\index{M!\code{make-double-float}}
\index{M!\code{make-long-float}}

\DSyntax{}

\code{make-short-float} \varname{bytes}
$\Rightarrow$ \varname{result}\\
\code{make-single-float} \varname{bytes}
$\Rightarrow$ \varname{result}\\
\code{make-double-float} \varname{bytes}
$\Rightarrow$ \varname{result}\\
\code{make-long-float} \varname{bytes}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{bytes} -- An integer or bit-vector representing the binary
pattern of a floating point number.\\
\varname{result} -- the resulting floating point number or \code{NAN}.

\DDescription{}

The functions construct a floating point number of appropriate
float type starting from the bit content of
\varname{bytes}.

If \varname{bytes} corresponds to the byte pattern of a \emph{NaN},
then a \code{NAN} is returned.

The actual float type returned by the functions is the widest one
supported by the implementation; i.e., a call to
\code{make-long-float} may return a \code{double-float}.

\DExceptional{}

The functions signals a \code{type-error} if \varname{bytes} is not of
the type described above

\DSeeAlso{}

\code{NAN}, \code{Q-NAN}, \code{S-NAN}, \code{make-float}.

\DNotes{}

These functions are, in one form or another, already present in \CL{}
implementations.

Implementations may supply a larger set of these functions, e.g.,
\code{make-quad-float}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Variables \code{NAN}, \code{S-NAN}, \code{Q-NAN}}
\index{N!NaNs!\code{NAN}}
\index{N!NaNs!\code{S-NAN}}
\index{N!NaNs!\code{Q-NAN}}

\DValues{}

All \emph{implementation-dependent values}.


\DDescription{}

The values \code{NAN}, \code{Q-NAN}, and \code{S-NAN} hold a
representation of a ``not a number'' object.  The object can either be
a \emph{quiet} (\code{Q-NAN}) or a \emph{signaling} (\code{S-NAN})
\emph{NaN} (see~\cite{2008:IEEE-754}).  \code{NAN} is always a
\emph{quiet NaN}.


\DExamples{}

The actual values of \code{NAN} vary from implementation to
implementation.  Here are two examples of how \code{NAN} can be
represented in two implementations:

\begin{alltt}
SBCL> \codeprompt{NAN}
\textit{#<DOUBLE-FLOAT quiet NaN>}
\textcolor{red}{;;; E.g., the result of (sb-kernel:make-double-float -524288 0)}
\end{alltt}

\begin{alltt}
LW> \codeprompt{NAN}
\textit{1D+-0} \textcolor{red}{#| 1D+-0 is double-float not-a-number |#}
\end{alltt}

\DNotes{}

\noindent
It is to be understood that testing for equality of two \code{NAN}s is
not meaningful.  Especially testing for \code{eq} or \code{eql}.

\noindent
It is also understood that, \code{(numberp nan)} should return \code{T}.

\DSeeAlso{}

\code{is-nan}, \code{nanp}, \code{is-quiet-nan}, \code{quiet-nan-p},
\code{is-signaling-nan}, \code{signaling-nan-p}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{is-nan}, \code{nanp},\\
  \code{is-quiet-nan},
  \code{quiet-nan-p},\\
  \code{is-signaling-nan},
  \code{signaling-nan-p}
}
\index{I!\code{is-nan}}
\index{N!\code{nanp}}
\index{I!\code{is-quiet-nan}}
\index{Q!\code{quiet-nan-p}}
\index{I!\code{is-signaling-nan}} 
\index{S!\code{signaling-nan-p}}

\DSyntax{}

\code{is-nan} \varname{x} $\Rightarrow$ \textit{boolean}\\
\code{nanp} \varname{x} $\Rightarrow$ \textit{boolean}\\
\code{is-quiet-nan} \varname{x} $\Rightarrow$ \textit{boolean}\\
\code{quiet-nan-p} \varname{x} $\Rightarrow$ \textit{boolean}\\
\code{is-signaling-nan} \varname{x} $\Rightarrow$ \textit{boolean}\\
\code{signaling-nan-p} \varname{x} $\Rightarrow$ \textit{boolean}\\

\DArgsNValues{}

\varname{x} -- any \CL{} object.

\DDescription{}

The function \code{is-nan} (respectively \code{nanp} etc.) returns \code{T}
whenever \varname{x} is a (representation of an IEEE) NaN.  Otherwise
it returns \code{NIL}. The \emph{quiet} and \emph{signaling} versions
operate similarly.

\DExamples{}
%\subsubsection*{Example:}

\begin{alltt}
CL prompt> \codeprompt{(is-nan nan)}
\textit{T}

CL prompt> \codeprompt{(nanp nan)}
\textit{T}

CL prompt> \codeprompt{(is-nan 42)}
\textit{NIL}

CL prompt> \codeprompt{(is-nan "NaN")}
\textit{NIL}
\end{alltt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Constant Variables\\
  \code{long-float-positive-infinity},
  \code{long-float-negative-infinity},\\
  \code{double-float-positive-infinity},
  \code{double-float-negative-infinity},\\
  \code{single-float-positive-infinity},
  \code{single-float-negative-infinity},\\
  \code{short-float-positive-infinity},
  \code{short-float-negative-infinity},\\
  \code{infL},
  \code{infD},
  \code{infF},
  \code{infS}
}
\index{I!Infinities!\code{long-float-positive-infinity}}
\index{I!Infinities!\code{long-float-negative-infinity}}
\index{I!Infinities!\code{double-float-positive-infinity}}
\index{I!Infinities!\code{double-float-negative-infinity}}
\index{I!Infinities!\code{single-float-positive-infinity}}
\index{I!Infinities!\code{single-float-negative-infinity}}
\index{I!Infinities!\code{short-float-positive-infinity}}
\index{I!Infinities!\code{short-float-negative-infinity}}
\index{I!Infinities!\code{infL}}
\index{I!Infinities!\code{infD}}
\index{I!Infinities!\code{infF}}
\index{I!Infinities!\code{infS}}  
% \index{I!Infinities!\code{+infL0}}, 
% \index{I!Infinities!\code{-infL0}},
% \index{I!Infinities!\code{+infD0}}, 
% \index{I!Infinities!\code{-infD0}},
% \index{I!Infinities!\code{+infF0}}, 
% \index{I!Infinities!\code{-infF0}},
% \index{I!Infinities!\code{+infS0}}, 
% \index{I!Infinities!\code{-infS0}},

\DValues{}

The value of each of these constants is
\emph{implementation-dependent}.

\DDescription{}

The value of each of these constants must conform with the format
(i.e., the floating point type) codified in the name.

\DExamples{}

\begin{alltt}
SBCL> \codeprompt{single-float-positive-infinity}
\textit{#.SB-EXT:SINGLE-FLOAT-POSITIVE-INFINITY}
\end{alltt}

\begin{alltt}
LW> \codeprompt{single-float-positive-infinity}
\textit{+1F++0} \textcolor{red}{#| +1F++0 is single-float plus-infinity |#}
\end{alltt}

\begin{alltt}
LW> \codeprompt{-infD0}
\textit{-1D++0} \textcolor{red}{#| -1D++0 is double-float plus-infinity |#}
\end{alltt}

\begin{alltt}
LW> \codeprompt{-infL0}
\textit{-1D++0} \textcolor{red}{#| -1D++0 is double-float plus-infinity |#}
\textcolor{red}{;;; Note that in this case the widest float representation
;;; available is DOUBLE-FLOAT.}
\end{alltt}


\DNotes{}

The ``short'' names and the ``long ones'' are completely equivalent.
A possible implementation would be the following:
\begin{alltt}
(define-symbol-macro -infD0 double-float-negative-infinity)
\end{alltt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{is-infinity}, \code{infinityp}}
\index{I!\code{is-infinity}}
\index{I!\code{infinityp}}

\DSyntax{}

\code{is-infinity} \varname{x} $\Rightarrow$ \textit{boolean}\\
\code{infinityp} \varname{x} $\Rightarrow$ \textit{boolean}

\DArgsNValues{}

\varname{x} -- any \CL{} object.

\DDescription{}

The function \code{is-infinity} (respectively \code{infinityp}) returns \code{T}
whenever \varname{x} is a (representation of an IEEE) infinity.  Otherwise
it returns \code{NIL}.


\subsubsection*{Example:}

\begin{alltt}
CL prompt> \codeprompt{(is-infinity double-float-negative-infinity)}
\textit{T}

CL prompt> \codeprompt{(infinityp nan)}
\textit{NIL}

CL prompt> \codeprompt{(is-infinity 42)}
\textit{NIL}

CL prompt> \codeprompt{(is-infinity "NaN")}
\textit{NIL}
\end{alltt}


\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Floating Point Exception Handling Dictionary}
\label{sect:fpe-dictionary}

The following are the defined symbols (variables, constants, functions
and macros) pertaining to the handling of the low-level
\clieeeterm{floating point environment}.  The term \emph{notification}
is often used in lieu of \emph{exceptional value} (cfr., \cite{2012:LIA1})
in order to minimize confusion.  In particular the term is used for
names pertaining the NRI notification modality (see Section
\ref{sect:notifications}).


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Type \code{fpe-notification}}
\index{F!\code{fpe-notification}}

\DSupertypes{}

\code{fpe-notification}, \ldots, \code{T}

\DDescription{}

The \code{fpe-notification} type is defined to be:
\begin{alltt}
(member :divide-by-zero :infinitary
        :inexact
        :invalid
        :underflow
        :overflow
        :absolute-precision-underflow
        )
\end{alltt}
The meaning of these values correspond to a the possible
\emph{exceptional values} supported by an implementation.

\DSeeAlso{}

\code{fpe-notification-set}, \code{+fpe-all-notification+}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Type \code{fpe-notification-set}}
  \index{F!\code{fpe-notification-set}}

\DSupertypes{}

\code{fpe-notification-set}, \ldots, \code{T}.

\DDescription{}

Objects of this type have an \emph{implementation dependent}
representation. They represent sets of \code{fpe-notification} objects.

\DNotes{}

The actual implementation may be a \code{list} or an
\code{(unsigned-byte 8)}.  Users should not rely on a particular
underlying implementation.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Constant Variable \code{+fpe-all-notifications+}}
\index{*!\code{+fpe-all-notifications+}}

\DValues{}

A value of type \code{fpe-notification-set}.

\DDescription{}

The value \code{+fpe-all-notifications+} holds a representation the set of
exceptions -- whose members are of type \code{fpe-notification} -- that
are supported by the implementation.


\DSeeAlso{}

\code{fpe-notification}, \code{fpe-notification-set},
\code{all-supported-notifications-p},\\
\code{some-supported-notifications-p},
\code{supported-notification-p}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{supported-notification-p},\\
  \code{all-supported-notifications-p},
  \code{some-supported-notifications-p}}
\index{S!\code{supported-notification-p}}
\index{A!\code{all-supported-notifications-p}}
\index{S!\code{some-supported-notifications-p}}

\DSyntax{}

\code{supported-notification-p}
\varname{exception} $\Rightarrow$ \textit{boolean}\\
\code{all-supported-notifications-p} \code{\&rest}
\varname{exceptions} $\Rightarrow$ \textit{boolean}\\
\code{some-supported-notifications-p} \code{\&rest}
\varname{exceptions} $\Rightarrow$ \textit{boolean}

\DArgsNValues{}

\varname{exception} -- a \CL{} object of type 
\code{fpe-notification}.\\
\varname{exceptions} -- a list of \CL{} objects each of type 
\code{fpe-notification}.


\DDescription{}

The functions returns a true value if the exceptions passed as
arguments are supported by the implementation.

The function \code{supported-notification-p} returns true if 
\varname{exception} is supported by the implementation, and \code{NIL}
otherwise.

The function \code{all-supported-notifications-p} returns true if all the
elements in \varname{exceptions} are supported by the implementation,
and \code{NIL} otherwise.

The function \code{some-supported-notifications-p} returns true if any the
elements in \varname{exceptions} is supported by the implementation,
and \code{NIL} otherwise.

\DExamples{}

\begin{alltt}
CL prompt> \codeprompt{(supported-notification-p :divide-by-zero)}
\textit{T} \textcolor{red}{; Or could be be NIL.}

CL prompt> \codeprompt{(some-supported-notifications-p :divide-by-zero :inexact)}
\textit{T} \textcolor{red}{; Assuming the previous operation returned true.}

CL prompt> \codeprompt{(all-supported-notification-p :divide-by-zero :inexact)}
\textit{NIL} \textcolor{red}{; Or could be be T.}
\end{alltt}

\DExceptional{}

The functions signal a \code{type-error} if \varname{exception}
is not of type \code{fpe-notification} or if \varname{exceptions} contains
objects not of type \code{fpe-notification}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{fpe-test-notifications}}
\index{F!\code{fpe-test-notifications}}

\DSyntax{}

\code{fpe-test-notifications} \code{\&rest} \varname{excps}
$\Rightarrow$ \varname{excp-set}

\DArgsNValues{}

\varname{excps} -- A list of \code{fpe-notification} items.\\
\varname{excp-set} -- An object of type \code{fpe-notification-set}.

\DDescription{}

The function tests which of the \varname{excps} is set (i.e., whether
the corresponding flag is set in the underlying floating point
environment) and returns an object of type \code{fpe-notification-set}
with the corresponding flag set.

\DExamples{}

The following example (adapted from \cite{2018:C18}) shows how a piece of
code may decide how to \emph{handle} either
\code{floating-point-invalid-operation} or
\code{floating-point-overflow} (cfr., \cite{1996:ANSIHyperSpec}.)

\begin{alltt}
(let ((fpe-excps \textcolor{blue}{(fpe-test-notifications :overflow :invalid)}))
   (when (fpe-check-notifications :invalid)
     (signal 'cl:floating-point-invalid-operation))
   (when (fpe-check-notifications :overflow)
     (signal 'cl:floating-point-overflow))
   )
\end{alltt}

\DNotes{}

The \code{fpe-test-notifications} function accesses the current floating
point environment.  \CL{} implementations may have made different
choices about if, when, and how to signal the standard \CL{} floating
point conditions.  That is, the above example may or may not work in a
given \CL{} implementation, as the code that actually set the floating
environment exception flags may have already signaled either
\code{cl:floating-point-invalid-operation} or
\code{cl:floating-point-overflow}, and the some corresponding handling
code may have already cleared the flags.

\DSeeAlso{}

\code{fpe-notification}, \code{fpe-notification-set},
\code{fpe-check-notifications},\\
\code{cl:floating-point-invalid-operation},
\code{cl:floating-point-overflow}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{fpe-check-notifications}}
\index{F!\code{fpe-check-notifications}}

\DSyntax{}

\code{fpe-check-notifications} \varname{excp-set} \code{\&rest} \varname{excps}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{excp-set} -- An object of type \code{fpe-notification-set}\\
\varname{excps} -- A list of \code{fpe-notification} items.\\
\varname{result} -- A boolean.

\DDescription{}

The function checks whether \emph{all} of the \varname{excps} flags
are set in the \varname{excp-set} and returns a boolean indicating the
result.  If the \varname{excps} is empty, then the function returns
\code{NIL}.

\DExamples{}

The following example (adapted from \cite{2018:C18}) shows how a piece of
code may decide how to \code{signal} either
\code{floating-point-invalid-operation} or
\code{floating-point-overflow} (cfr., \cite{1996:ANSIHyperSpec}.)

\begin{alltt}
(let ((fpe-excps (fpe-test-notifications :overflow :invalid)))
   (when \textcolor{blue}{(fpe-check-notifications :invalid)}
     (signal 'cl:floating-point-invalid-operation))
   (when \textcolor{blue}{(fpe-check-notifications :overflow)}
     (signal 'cl:floating-point-overflow))
   )
\end{alltt}

\DNotes{}

Note that the value returned when \varname{excps} is empty is nor what
\CL{} users may expect from a function that looks like a call to
\code{(and)}.

The notes about \code{fpe-test-notifications} regarding the example above
apply also in the case of \code{fpe-check-notifications}.


\DSeeAlso{}

\code{fpe-notification}, \code{fpe-notification-set},
\code{fpe-test-notifications},\\
\code{cl:floating-point-invalid-operation},
\code{cl:floating-point-overflow}.


\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Floating Point Environment}
\label{sect:floating-point-env}

The \CLang{} specification \cite{2018:C18}, Section~7.6, defines the \emph{Floating
  Point Environment} for a \CLang{} implementation.  Various \CL{}
implementations provide access to the floating point environment, but
with a wide range of interfaces, which boils down tho the assumed
representation of the \CLang{} \code{fenv\_t} type, described in
\cite{2018:C18}.

This specification describes an interface which should accommodate the
current -- at the tie of this writing -- treatment of the floating
point environment provided by various \CL{} implementations.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Type \code{}}
\index{F!\code{floating-point-environment}}

\DSupertypes{}

\code{floating-point-environment}, \ldots, \code{T}

\DDescription{}

The actual \code{floating-point-environment} definition is
\emph{implementation dependent}.  The definition is used to specify
the type of arguments being used by the functions comprising the
interface.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Accessors
  \code{fpe-traps},
  \code{fpe-rounding-mode},
  \code{fpe-current-notifications},
  \code{fpe-accrued-notifications},
  \code{fpe-precision},
  \code{fpe-fast-mode-p},
}
\index{F!\code{fpe-traps}}      % Change to FPE-NOTIFICATIONS
\index{F!\code{fpe-rounding-mode}}
\index{F!\code{fpe-current-notifications}}
\index{F!\code{fpe-accrued-notifications}}
\index{F!\code{fpe-precision}}
\index{F!\code{fpe-fast-mode-p}}

\DSyntax{}

\code{fpe-traps} \varname{fpe} $\Rightarrow$ \varname{traps}\\
\code{fpe-rounding-mode} \varname{fpe} $\Rightarrow$ \varname{rounding-mode}\\
\code{fpe-current-notifications} \varname{fpe} $\Rightarrow$ \varname{exceptions}\\
\code{fpe-accrued-notifications} \varname{fpe} $\Rightarrow$ \varname{exceptions}\\
\code{fpe-precision} \varname{fpe} $\Rightarrow$ \varname{precision}\\
\code{fpe-fast-mode-p} \varname{fpe} $\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{fpe} -- An object of type \code{floating-point-environment}.\\
\varname{rounding-mode} -- A member of the type \code{rounding-mode}.\\
\varname{exceptions} -- An object of type \code{fpe-notification-set}.\\
\varname{precision} -- One of the one of the integers 24, 53 and 64.\\
\varname{result} -- A \emph{boolean}.

\DDescription{}

The ``accessors'' (readers -- functions) extract information from
\varname{fpe}.


\DNotes{}

See also Section~\ref{sect:rounding} (below.)

\DSeeAlso{}

\code{floating-point-environment}, \code{rounding-mode},
\code{fpe-notification-set}. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{set-floating-point-environment}}
\index{S!\code{set-floating-point-environment}}

\DSyntax{}

\begin{tabbing}
\code{set-floating-point-environment} \= \code{\&key}\\
\>\varname{traps}\\
\>\varname{rounding-mode}\\
\>\varname{current-notifications}\\
\>\varname{precision}\\
\>\code{\&allow-other-keys}\\
$\Rightarrow$ \varname{modes}
\end{tabbing}


\DArgsNValues{}

\varname{traps} -- A list of the exception conditions that should cause
traps.\\
\varname{rounding-mode} -- The rounding mode to use when the result is
not exact.\\
\varname{current-notifications} -- The argument is used to set the current
set of exceptions.\\
\varname{precision} -- An integer.\\
\varname{modes} -- An a-list containing the current floating
point modes; the indicators are keywords.

\DDescription{}

This function sets options controlling the floating-point
hardware. If a keyword is not supplied, then the current value is
preserved.

The possible values for each of the keywords are the
following.

\begin{itemize}
\item \varname{traps} is a list that can contain the keywords
  \code{:underflow}, \code{:overflow}, \code{:inexact}, \code{:invalid},
  \code{:divide-by-zero}, and \code{:denormalized-operand}.

\item \varname{rounding-mode} is the rounding mode to use when the result is
  not exact; it can assume the values \code{:nearest},
  \code{:positive-infinity}, \code{:negative-infinity} and
  \code{:zero}.

\item \varname{current-notifications} is used to set the exception flags. The
  main use is setting the accrued exceptions to \code{NIL} to clear
  them.

\item \varname{precision} can be one of the integers 24, 53 and 64, standing for
  the internal precision of the mantissa.
\end{itemize}

\DExamples{}

None.


\DNotes{}

None.


\DExceptional{}

The function can always result in a no-op if access to the underlying
hardware is not fully supported.  When this happens
\code{set-floating-point-environment} must issue a warning.


\DSeeAlso{}

\code{get-floating-point-environment}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{get-floating-point-environment}}
\index{G!\code{get-floating-point-environment}}

\DSyntax{}

\code{get-floating-point-environment} \textit{$<$no arguments$>$}
$\Rightarrow$ \varname{modes}

\DArgsNValues{}

\varname{modes} --  An object of type \code{floating-point-environment}.


\DDescription{}

The function returns an a-list that represents the current state of
the floating point modes in use at the time.  The format of the
returned \varname{modes} a-list is such to be
usable as an \code{apply} last argument for
\code{set-floating-point-environment}.


\DExamples{}

\begin{alltt}
SBCL> \codeprompt{(get-floating-point-environment)}
\textit{(:TRAPS (:OVERFLOW :INVALID :DIVIDE-BY-ZERO)
 :ROUNDING-MODE :NEAREST
 :CURRENT-NOTIFICATIONS (:INEXACT)
 :FAST-MODE NIL
 :PRECISION :53-BIT)}
\end{alltt}


\DSeeAlso{}

\code{set-floating-point-environment}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{default-floating-point-environment}}
\index{D!\code{default-floating-point-environment}}

\DSyntax{}

\code{default-floating-point-environment} \textit{$<$no arguments$>$}
$\Rightarrow$ \varname{fpe}

\DArgsNValues{}

\varname{fpe} -- An object of type \code{floating-point-environment}.

\DDescription{}

The function returns an object of type
\code{floating-point-environment} that represents the \emph{default}
floating point environment in use by the implementation.

% The format of the returned \varname{fpe} a-list is such to be usable
% as an \code{apply} last argument for
% \code{set-floating-point-environment}.

\DExamples{}

\begin{alltt}
SBCL> \codeprompt{(default-floating-point-environment)}
\textit{(:TRAPS (:OVERFLOW :INVALID :DIVIDE-BY-ZERO)
 :ROUNDING-MODE :NEAREST
 :CURRENT-NOTIFICATIONS (:INEXACT)
 :FAST-MODE NIL
 :PRECISION :53-BIT)}
\textcolor{red}{;;; The format of the result for SBCL is incidental.
;;; The fpe-* readers can be made to work with such representation.}
\end{alltt}

\DNotes{}

The function \code{default-floating-point-environment} should always return
the same (or \code{equalp}) value.

\DSeeAlso{}

\code{set-floating-point-environment}, \code{get-floating-point-environment}.


\newpage
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Macro \code{with-floating-point-environment}}
\index{W!\code{with-floating-point-environment}}

\DSyntax{}

% \code{with-floating-point-environment} (\textit{\code{\&key}}
% \varname{traps}
% \varname{rounding-mode}
% \varname{current-notifications}
% \varname{precision}
% \varname{\code{\&allow-other-keys}}) \code{\&body} \varname{body}
% $\Rightarrow$ \varname{results}

\begin{tabbing}
\code{with-floating-point-environment} \=(\=\code{\&key}\\
\>\>                                \varname{traps}\\
\>\>                                \varname{rounding-mode}\\
\>\>                                \varname{current-notifications}\\
\>\>                                \varname{precision}\\
\>\>                                \code{\&allow-other-keys})\\
\> \code{\&body} \varname{body}\\
$\Rightarrow$ \varname{results}
\end{tabbing}




\DArgsNValues{}

\varname{traps} -- A list of the exception conditions that should cause
traps.\\
\varname{rounding-mode} -- The rounding mode to use when the result is
not exact.\\
\varname{current-notifications} -- The argument is used to set the current
set of exceptions.\\
\varname{precision} -- An integer.\\
\varname{results} -- One or more \CL{} objects.


\DDescription{}

The \code{with-floating-point-environment} macro executes \varname{body} in a
an environment where the floating point modes are determined by the
values passed as arguments to the macro.  Upon termination (either
normal or exceptional) of the code in \varname{body} the floating
point modes are restored to those in effect before the execution of\\
\code{with-floating-point-environment}.

As for \code{set-floating-point-environment} the values that the arguments
can take are the following:

\begin{itemize}
\item \varname{traps} is a list that can contain the keywords
  \code{:underflow}, \code{:overflow}, \code{:inexact}, \code{:invalid},
  \code{:divide-by-zero}, and \code{:denormalized-operand}.

\item \varname{rounding-mode} is the rounding mode to use when the result is
  not exact; it can assume the values \code{:nearest},
  \code{:positive-infinity}, \code{:negative-infinity} and
  \code{:zero}.

\item \varname{current-notifications} is used to set the exception flags. The
  main use is setting the accrued exceptions to \code{NIL} to clear
  them.

\item \varname{precision} can be one of the integers 24, 53 and 64,
  standing for the internal precision of the mantissa.
\end{itemize}



\noindent
\varname{results} is the value (or values) returned by \varname{body}.


\DNotes{}

When called with an empty arguments list,
\code{with-floating-point-environment} is a no-op and \varname{body}
is executed as-is.

\DExceptional{}

The macro \code{with-floating-point-environment} performs a minimal
code-walk of \varname{body} and if it finds some floating point
operation which potentially may not respect the changed environment as
described by the specified arguments, it then issues a warning.


\DSeeAlso{}

\code{get-floating-point-environment},
\code{set-floating-point-environment}\\
\code{with-rounding-mode}.


\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Rounding}
\label{sect:rounding}

Having control over IEEE rounding modes is necessary to implement a
number of numerical algorithms and data structures. The following
entries provide access to the IEEE facilities.


\DDictionaryItem{Type \code{rounding-mode}}
\index{R!\code{rounding-mode}}

\DSupertypes{}

\code{rounding-mode}, \ldots, \code{T}

\DDescription{}

The \code{rounding-mode} type is defined to be:
\begin{alltt}
(member :indeterminable
        :zero
        :nearest
        :positive-infinity
        :negative-infinity)
\end{alltt}
The meaning of these values correspond to a direction of floating
point rounding.


\DNotes{}

The keywords used correspond to the \CLang{} Library \cite{2018:C18}
\textbf{\code{FLT\_ROUNDS}} values of:

\vspace*{3mm}

\begin{tabular}{rl}
  \textbf{\code{-1}} & indeterminable.\\
  \textbf{\code{0}}  & toward zero.\\
  \textbf{\code{1}}  & toward nearest.\\
  \textbf{\code{2}}  & toward positive infinity.\\
  \textbf{\code{3}}  & toward negative infinity.\\
\end{tabular}

\vspace*{3mm}

As per the \CLang{} Library standard, \CL{} implementations can extend the
type \code{rounding-modes} with other keywords representing
\emph{implementation dependent} rounding modes.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{get-rounding-mode}}
\index{G!\code{get-rounding-mode}}

\DSyntax{}

\code{get-rounding-mode} \textit{$<$no arguments$>$}
$\Rightarrow$ \varname{rounding-mode}

\DArgsNValues{}

\varname{rounding-mode} -- a value of type \code{rounding-modes}.

\DDescription{}

The function returns the current rounding mode.  The value
\code{:indeterminate} is returned if such rounding mode cannot be
determined.

\DSeeAlso{}

\code{rounding-modes}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\DDictionaryItem{Function \code{set-rounding-mode}}
\index{S!\code{set-rounding-mode}}

\DSyntax{}

\code{set-rounding-mode} \varname{rounding-mode}
$\Rightarrow$ \varname{result}, \varname{success}

\DArgsNValues{}

\varname{rounding-mode} -- a \code{rounding-mode}\\
\varname{result} -- a \code{rounding-mode}\\
\varname{success} -- a boolean


\DDescription{}

The function sets the rounding mode.  If the setting of the rounding
mode is successful, then \varname{rounding-node} is returned as
\varname{result} and \varname{success} is \code{T}.  Otherwise, the
rounding mode before the the call is returned with \varname{success}
\code{NIL}.\marginnote{Should it instead signal an error?}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Macro \code{with-rounding-mode}}
\index{W!\code{with-rounding-mode}}

\DSyntax{}

\code{with-rounding-mode} \code{(} \varname{rm} \code{)} \code{\&body}
\varname{body}\\
$\Rightarrow$ \varname{results}

\DArgsNValues{}

\varname{rm} -- An item of type \code{rounding-modes}.\\
\varname{body} -- An implicit \code{progn} of code.\\
\varname{results} -- The value (or values) returned by \varname{body}.

\DDescription{}

The code in \varname{body} is executed with a floating point
environment where the rounding mode is set to \varname{rm}.  The
previous rounding mode is saved before executing \varname{body} and it
is restored (as if using \code{unwind-protect}) upon exit.

\DExceptional{}

The macro \code{with-rounding-mode} performs a minimal code-walk of
\varname{body} and if it finds some floating point operation which
potentially may not respect the rounding mode \varname{rm} issues a
warning.
%
It is assumed that this warning will be raised at macro-expansion
time.

\DExamples{}

The following examples may be from two implementations behaving
differently with respect to their handling of rounding modes at the
\CL{} package level.

\begin{alltt}
CL(A) prompt> \codeprompt{(with-rounding-mode (:positive-infinity)
                  (cl:* 2 21.0))}
\textit{42.0}
\end{alltt}

\begin{alltt}
CL(B) prompt> \codeprompt{(with-rounding-mode (:positive-infinity)
                  (cl:* 2 21.0))}
\textcolor{red}{Warning:
the function CL:* may not respect the new rounding mode :POSITIVE-INFINITY.}
\textit{42.0}
\end{alltt}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Macros \code{round-to-zero}, \code{round-to-near},\\
  \code{round-upward}, \code{round-downward}}
\index{R!\code{round-to-zero}}
\index{R!\code{round-to-near}}
\index{R!\code{round-upward}}
\index{R!\code{round-downward}}

\DSyntax{}

\code{round-to-zero} \code{\&body} \varname{body}
$\Rightarrow$ \varname{results}\\
\code{round-to-near} \code{\&body} \varname{body}
$\Rightarrow$ \varname{results}\\
\code{round-upward} \code{\&body} \varname{body}
$\Rightarrow$ \varname{results}\\
\code{round-downward} \code{\&body} \varname{body}
$\Rightarrow$ \varname{results}

\DArgsNValues{}

\varname{body} -- a sequence of forms; i.e., an implicit \code{progn}.\\
\varname{results} -- the value(s) returned by \varname{body}.

\DDescription{}

The macros evaluate \varname{body} within an environment where the
rounding mode is set to to the macro's namesake.  The rounding mode is
reset to the one surrounding the macro call upon returning or raising
a condition (as in \code{unwind-protect}).

\DExceptional{}

None \marginnote{Maybe signal error if the rounding mode cannot be set?}




\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Floating Point \IEEEFPStd{} Respecting Operations}
\label{sect:fp-operations}

A \CL{} implementation or a \CL{} library implementing this
specification will provide the following \emph{non-computational
  operations} (to follow the language of Section~5 of \cite{2008:IEEE-754})
alongside some \CL{} features to allow for read-time (cfr.,
\emph{translation-time}) evaluations.


\subsection{Non-computational \CL{} Environment \IEEEFPStd{} Queries}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{is-cdr-ieee-754-conformant}}
\index{I!\code{is-cdr-ieee-754-conformant}}

\DSyntax{}

\code{is-cdr-ieee-754-conformant} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.

\DDescription{}

This function returns a non-\code{NIL} value if the \CL{}
implementation or the \CL{} library implements the specification of
this document.

If this function returns non-\code{NIL}, so will
\code{is-cdr-ieee-745-constants-providing},
\code{is-cdr-ieee-754-environment-providing} and
\code{is-cdr-ieee-745-operation-providing}.

\DSeeAlso{}

\code{is-cdr-ieee-745-constants-providing},
\code{is-cdr-ieee-754-environment-providing} and
\code{is-cdr-ieee-745-operation-providing}.

\DNotes{}

\cite{2008:IEEE-754} specifies two predicates \code{is754version1985} and
\code{is754version2008}, but they imply conformance to the full
\IEEEFPStd{} standard.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{is-cdr-ieee-745-constants-providing}}
\index{I!\code{is-cdr-ieee-745-constants-providing}}

\DSyntax{}

\code{is-cdr-ieee-745-constants-providing} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.

\DDescription{}

This function returns a non-\code{NIL} value if the \CL{}
implementation or the \CL{} library only provides the names of the
constants naming NaNs and infinities.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{is-cdr-ieee-745-environment-providing}}
\index{I!\code{is-cdr-ieee-745-environment-providing}}

\DSyntax{}

\code{is-cdr-ieee-745-environment-providing} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.

\DDescription{}

This function returns a non-\code{NIL} value if the \CL{}
implementation or the \CL{} library provides the operations for
accessing and manipulating floating point exceptions
\checkref{Sections references} and the floating
point environment.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{is-cdr-ieee-745-operation-providing}}
\index{I!\code{is-cdr-ieee-745-operation-providing}}

\DSyntax{}

\code{is-cdr-ieee-745-operation-providing} \varname{$<$no argument$>$}
$\Rightarrow$ \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.


\DDescription{}

This function returns a non-\code{NIL} value if the \CL{}
implementation or the \CL{} library provides separate implementations
of the \emph{computational operations} that do conform to the \IEEEFPStd{}
mandated behavior.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{is-cl-using-cdr-ieee-745}}
\index{I!\code{is-cl-using-cdr-ieee-745}}

\DSyntax{}

\code{is-cl-using-cdr-ieee-745} \varname{$<$no argument$>$}
\RArrow \varname{result}

\DArgsNValues{}

\varname{result} -- a generalized boolean.


\DDescription{}

This function returns a non-\code{NIL} value if the mathematical
operations in the ANSI \CL{} standard \cite{1996:ANSIHyperSpec} respect the
IEEE~745 specification.

\DNotes{}

This is a stronger requirement than the
presence of the \code{ieee-floating-point} feature in
\code{*features*}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Features \code{:cdr-ieee-745-constants-providing},\\
  \code{:cdr-ieee-745-environment-providing} and\\
  \code{:cdr-ieee-745-operation-providing}}
\index{*!\code{:cdr-ieee-745-constants-providing}}
\index{*!\code{:cdr-ieee-745-environment-providing}}
\index{*!\code{:cdr-ieee-745-operation-providing}}

\DDescription{}

These features are present in the \code{*features*} list whenever the
corresponding function, \code{is-}\emph{feature} returns a
non-\code{NIL} value.


\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Numeric Operations}

The following \CL{} operations, broken down according to the
classification in Section~12.1.1 of \cite{1996:ANSIHyperSpec} are exported
form the \code{CL-MATH-IEEE-2019} package
(cfr.,~\ref{sect:package}).

If \code{is-cdr-ieee-754-operation-providing} returns non-\code{NIL}
(and the\\
\code{:cdr-ieee-754-operation-providing} is in
\code{*features*}, then the operations are also implemented, otherwise
each of them signal an ``not implemented'' error;\\
see \code{ieee-754-not-implemented-item}.

The list of operations
recommended by \cite{2008:IEEE-754} is more extensive than the list of
operations provided by \CL{} (cfr., Table~9.1 in \cite{2008:IEEE-754}).
%
The tables referenced below provide correspondences for the \CL{} functions,
especially regarding the exceptions (conditions) that must be
signaled.

\paragraph{Rounding Modes.} In particular, all the operations listed
in Sections~\ref{sect:arith-ops} and~\ref{sect:transc-ops} respect the
\clieeeterm{rounding mode} set in the floating point
environment in effect when the operation is executed.

\paragraph{Underflow and Overflow.}  The operations listed signal
\code{cl:floating-point-overflow} and
\code{cl:floating-point-underflow} according to the rules established
in \cite{2008:IEEE-754} and Section~12.1.4.3 of \cite{1996:ANSIHyperSpec}.


\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Arithmetic Operations}
\label{sect:arith-ops}

\begin{table}[h!]
  \centering
  \begin{tt}
    \begin{tabular}{lll}
      * & 1+ & \ldots \\
      + & 1- & \ldots \\
      - & incf & conjugate\\
      / & decf & \\
    \end{tabular}
  \end{tt}
  \caption{The basic \CL{} arithmetic operations}
  \label{table:cl-arit-ops}
\end{table}

\noindent
Each of the functions in Table~\ref{table:cl-arit-ops} must be further
specified with respect to \cite{1996:ANSIHyperSpec} in order to adhere to
the requirements of \IEEEFPStd{}.  The descriptions and the references for
each function further specify the standard \CL{} behavior with respect
to \emph{NaN}s, \emph{infinities} and floating point exceptions.

\vspace*{3mm}

\noindent
Note that the \code{gcd}, and \code{lcm} functions are not
present in the above table, which corresponds to Figure~12-1 of
\cite{1996:ANSIHyperSpec}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{+}, \code{*}}
\index{*!\code{+}}
\index{*!\code{*}}

\DSyntax{}

\code{+} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{*} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{+} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\
\code{*} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\

\DArgsNValues{}

\varname{a}, \varname{b}, \varname{result} -- Floating Point numbers.\\
\varname{numbers} -- A, possibly empty, list of numbers.\\
\varname{n} -- A number.



\DDescription{}

The dyadic versions of the functions \code{+}, and \code{*}, when operating on
floating point numbers (or numbers that eventually are converted to
floating point numbers according to \CL{} float contagion rules -- cfr.,
Section~12.1.4 of \cite{1996:ANSIHyperSpec}) assume the behavior of the
underlying \IEEEFPStd{} specification \cite{2008:IEEE-754}.  It is assumed that
the multiple argument versions are eventually built upon the dyadic
ones (zero and one argument versions can be seen as special cases from
the point of view of this specification).

The dyadic versions of the functions \code{+}, and \code{*} behave
according to the \IEEEFPStd{} operations described in Section~5.4.1 of
\cite{2008:IEEE-754}, which is assumed to be the usual behavior specified
for \CL{} by \cite{1996:ANSIHyperSpec} when \varname{a} and \varname{b} are
not \emph{NaN}s or \emph{infinities}.

\noindent
The operations from \cite{2008:IEEE-754} are:

\vspace*{3mm}

\noindent
\textit{formatOf}-\textbf{addition}(\varname{a}, \varname{b})\\
\textit{formatOf}-\textbf{multiplication}(\varname{a}, \varname{b})

\vspace*{3mm}

\noindent
where \textit{formatOf} describes the resulting floating point
format.  As already mentioned, the actual floating point format of
\varname{result} is dictated by the \CL{} standard.

When \code{+}, or \code{*} is called with either \varname{a} or
\varname{b} being a \emph{quiet NaN}, and neither is a
\emph{signaling NaN} then \varname{result} is a (quiet) \code{NAN}.
No error (floating point exception) is signaled in this case.

When \code{+} is called with \varname{a} being an 
\clieeeterm{infinity} and \varname{b} being a finite \clterm{number}
(or vice-versa), then \varname{result} is \varname{a} (or, vice-versa, 
\varname{b}).

When \code{*} is called with \varname{a} being an
\clieeeterm{infinity} and \varname{b} being a non-zero finite
\clterm{number} (or vice-versa), then \varname{result} is \varname{a}
(or, vice-versa, \varname{b}).

\DExceptional{}

There are different exceptional situations to be considered.

\begin{enumerate}
\item When \code{+} is called with either \varname{a} or \varname{b}
  being a \emph{signaling NaN}, then the\\
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item When \code{+} is called with \varname{a} being a
  \clieeeterm{positive infinity} and \varname{b} being a
  \clieeeterm{negative infinity} (or vice-versa), then the
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item When \code{*} is called with \varname{a} being an
  \clieeeterm{infinity} and \varname{b} being a \clieeeterm{zero}
  value (or vice-versa), then the
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item If some of \varname{a}, \varname{b}, or any element of a non-empty
  \varname{numbers} is not a \CL{} \clterm{number} then the function
  might signal a \clname{cl:type-error}.
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{+.<}, \code{+.>}}
\index{*!\code{+.<}}
\index{*!\code{+.>}}


\code{+.<} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{+.>} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{+.<} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\
\code{+.>} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\

\DArgsNValues{}

\varname{a}, \varname{b}, \varname{result} -- Floating Point numbers.\\
\varname{numbers} -- A, possibly empty, list of numbers.\\
\varname{n} -- A number.

\DDescription{}

The functions  \code{+.<} and \code{+.>} perform sums as per \code{+}
but they establish a \emph{downward} and, respectively a
\emph{upward} rounding mode before performing the operation.

\DNotes{}

LIA1 suggests to call these operations \code{<+} and \code{+>}, but
then the symmetric subtraction ones hoard the the symbols \code{<-}
and \code{->}, which are surely used more often than not for some
specialized library.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{*.<}, \code{*.>}}
\index{*!\code{*.<}}
\index{*!\code{*.>}}


\code{*.<} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{*.>} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{*.<} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\
\code{*.>} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\

\DArgsNValues{}

\varname{a}, \varname{b}, \varname{result} -- Floating Point numbers.\\
\varname{numbers} -- A, possibly empty, list of numbers.\\
\varname{n} -- A number.

\DDescription{}

The functions  \code{*.<} and \code{*.>} perform multiplications as per \code{*}
but they establish a \emph{downward} and, respectively a
\emph{upward} rounding mode before performing the operation.

\DNotes{}

LIA1 suggests to call these operations \code{<*} and \code{*>}, but
then the symmetric subtraction ones hoard the the symbols \code{<-}
and \code{->}, which are surely used more often than not for some
specialized library.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{-}}
\index{*!\code{-}}

\DSyntax{}

\code{-} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{-} \varname{a} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\

\DArgsNValues{}

\varname{a}, \varname{b}, \varname{result} -- Floating Point numbers.\\
\varname{numbers} -- A, possibly empty, list of numbers.\\
\varname{n} -- A number.

\DDescription{}

The dyadic version of the function \code{-}, when operating on
floating point numbers (or numbers that eventually are converted to
floating point numbers according to \CL{} float contagion rules -- cfr.,
Section~12.1.4 of \cite{1996:ANSIHyperSpec}) assume the behavior of the
underlying \IEEEFPStd{} specification \cite{2008:IEEE-754}.  It is assumed that
the multiple argument versions are eventually built upon the dyadic
ones (the one argument version can be seen as a special case from
the point of view of this specification).

The dyadic version of the functions \code{-} behaves
according to the \IEEEFPStd{} operations described in Section~5.4.1 of
\cite{2008:IEEE-754}, which is assumed to be the usual behavior specified
for \CL{} by \cite{1996:ANSIHyperSpec} when \varname{a} and \varname{b} are
not \emph{NaN}s or \emph{infinities}.

\noindent
The operation from \cite{2008:IEEE-754} is:

\vspace*{3mm}

\noindent
\textit{formatOf}-\textbf{subtraction}(\varname{a}, \varname{b})

\vspace*{3mm}

\noindent
where \textit{formatOf} describes the resulting floating point
format.  As already mentioned, the actual floating point format of
\varname{result} is dictated by the \CL{} standard.

When \code{-} is called with either \varname{a} or \varname{b} being a
\emph{quiet NaN}, and neither is a \emph{signaling NaN} then
\varname{result} is a (quiet) \code{NAN}.  No error (floating point
exception) is signaled in this case.

When \code{-} is called with \varname{a} being an 
\clieeeterm{infinity} and \varname{b} being a finite \clterm{number}
(or vice-versa), then \varname{result} is \varname{a}; when \code{-} is
called with \varname{b} being an \clieeeterm{infinity} and \varname{a}
being a finite \clterm{number}, then \varname{result}
is $-$\varname{b}.


\DExceptional{}

There are different exceptional situations to be considered.

\begin{enumerate}
\item When \code{-} is called with either \varname{a} or \varname{b}
  being a \emph{signaling NaN}, then the\\
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item When \code{-} is called with \varname{a} being a
  \clieeeterm{positive infinity} and \varname{b} being a
  \clieeeterm{positive infinity}, or \varname{a} being a
  \clieeeterm{negative infinity} and \varname{b} being a
  \clieeeterm{positive infinity}, then the\\
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item If some of \varname{a}, \varname{b}, or any element of a non-empty
  \varname{numbers} is not a \CL{} \clterm{number} then the function
  might signal a \clname{cl:type-error}.
\end{enumerate}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{-.<}, \code{-.>}}
\index{*!\code{-.<}}
\index{*!\code{-.>}}


\code{-.<} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{-.>} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{-.<} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\
\code{-.>} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\

\DArgsNValues{}

\varname{a}, \varname{b}, \varname{result} -- Floating Point numbers.\\
\varname{numbers} -- A, possibly empty, list of numbers.\\
\varname{n} -- A number.

\DDescription{}

The functions  \code{-.<} and \code{-.>} perform subtractions as per \code{-}
but they establish a \emph{downward} and, respectively a
\emph{upward} rounding mode before performing the operation.

\DNotes{}

LIA1 suggests to call these operations \code{<-} and \code{->}, but the symbols \code{<-}
and \code{->} get ``used up'', which may cause some readability issues
as they are surely used more often than not for some specialized
library.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{/}}
\index{*!\code{/}}

\DSyntax{}

\code{/} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{/} \varname{n} \code{\&rest} \varname{ns} \RArrow \varname \code{r}\\

\DArgsNValues{}

\varname{a}, \varname{b}, \varname{result} -- Floating Point numbers.\\
\varname{numbers} -- A, possibly empty, list of numbers.\\
\varname{n}, \varname{r} -- A number.



\DDescription{}

The dyadic version of the function \code{/}, when operating on
floating point numbers (or numbers that eventually are converted to
floating point numbers according to \CL{} float contagion rules -- cfr.,
Section~12.1.4 of \cite{1996:ANSIHyperSpec}) assume the behavior of the
underlying \IEEEFPStd{} specification \cite{2008:IEEE-754}.  It is assumed that
the multiple argument versions are eventually built upon the dyadic
ones (the one argument version can be seen as a special case from
the point of view of this specification).

The dyadic version of the functions \code{/} behaves
according to the \IEEEFPStd{} operations described in Section~5.4.1 of
\cite{2008:IEEE-754}, which is assumed to be the usual behavior specified
for \CL{} by \cite{1996:ANSIHyperSpec} when \varname{a} and \varname{b} are
not \emph{NaN}s or \emph{infinities}.


\noindent
The operation from \cite{2008:IEEE-754} is:

\vspace*{3mm}

\noindent
\textit{formatOf}-\textbf{division}(\varname{a}, \varname{b})

\vspace*{3mm}

\noindent
where \textit{formatOf} describes the resulting floating point
format.  As already mentioned, the actual floating point format of
\varname{result} is dictated by the \CL{} standard.

When \code{/} is called with either \varname{a} or \varname{b} being a
\emph{quiet NaN}, and neither is a \emph{signaling NaN} then
\varname{result} is a (quiet) \code{NAN}.  No error (floating point
exception) is signaled in this case.

When \code{/} is called with \varname{a} being an 
\clieeeterm{infinity} and \varname{b} being a finite \clterm{number}
(or vice-versa), then \varname{result} is \varname{a} with its sign
possibly changed; when \code{/} is
called with \varname{b} being an \clieeeterm{infinity} and \varname{a}
being a finite \clterm{number}, then \varname{result}
is \clieeeterm{zero}.


\DExceptional{}

There are different exceptional situations to be considered.

\begin{enumerate}
\item When \code{/} is called with either \varname{a} or \varname{b}
  being a \emph{signaling NaN}, then the\\
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item When \code{/} is called with \varname{a} being an 
  \clieeeterm{infinity} and \varname{b} being an 
  \clieeeterm{infinity} as well, then the\\
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item When \code{/} is called with \varname{a} being a
  \clieeeterm{zero} and \varname{b} being an 
  \clieeeterm{zero} as well, then the\\
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item When the dyadic version of \code{/} is called with \varname{a}
  being a finite \clterm{number} and \varname{b} being a
  \clieeeterm{zero}, or when the monadic version of \code{/} is called
  with \varname{n} being a \clieeeterm{zero}, then the
  \clname{cl:division-by-zero} error is signaled.

\item If some of \varname{a}, \varname{b}, or a
  any element of a non-empty
  \varname{numbers} is not a \CL{} \clterm{number} then the function
  will signal a \clname{cl:type-error}.
\end{enumerate}

\noindent
The monadic version of the function \code {/} behaves as \code{(/ 1}
\varname{n}\code{)} with respect to exceptions being signaled.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{/.<}, \code{/.>}}
\index{*!\code{/.<}}
\index{*!\code{/.>}}


\code{/.<} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{/.>} \varname{a} \varname{b} \RArrow \varname{result}\\
\code{/.<} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\
\code{/.>} \code{\&rest} \varname{ns} \RArrow \varname \code{n}\\

\DArgsNValues{}

\varname{a}, \varname{b}, \varname{result} -- Floating Point numbers.\\
\varname{numbers} -- A, possibly empty, list of numbers.\\
\varname{n} -- A number.

\DDescription{}

The functions  \code{/.<} and \code{/.>} perform division as per \code{/}
but they establish a \emph{downward} and, respectively a
\emph{upward} rounding mode before performing the operation.

\DNotes{}

LIA1 suggests to call these operations \code{</} and \code{/>}, but
then the symmetric subtraction ones hoard the the symbols \code{<-}
and \code{->}, which are surely used more often than not for some
specialized library.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{1+}, \code{1-}}
\index{*!\code{1+}}
\index{*!\code{1-}}

\DSyntax{}

\code{1+} \varname{n} \RArrow ~ \varname{result}\\
\code{1-} \varname{n} \RArrow ~ \varname{result}\\

\DArgsNValues{}

\varname{n} -- A \clterm{number}.\\
\varname{result} -- A \clterm{number}.


\DDescription{}

The functions \code{1+}, \code{1-}, behave
as the \CL{} counterparts on non-\clieeeterm{NaN}s and
non-\clieeeterm{infinities} (see \cite{1996:ANSIHyperSpec}).

The functions \code{1+}, \code{1-} return a \clieeeterm{quiet NaN} as \varname{result}
when \varname{n} is a \clieeeterm{quiet NaN}; they return an
\clieeeterm{infinity} equal to \varname{n}, when \varname{n} is an
\clieeeterm{infinity}.

\DExceptional{}

There are different exceptional situations to be considered.

\begin{enumerate}
\item When \code{1+} or \code{1-} is called with \varname{n}
  being a \emph{signaling NaN}, then the\\
  \clname{cl:floating-point-invalid-operation} error is signaled.

\item If \varname{n} is not a \CL{} \clterm{number} then the function
  signals a \clname{cl:type-error}.
\end{enumerate}

\DSeeAlso{}

\code{+}, \code{-}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Macros \code{incf}, \code{decf}}
\index{I!\code{incf}}
\index{D!\code{decf}}

\DSyntax{}

\code{incf} \varname{place} \code{\&optional} \varname{d} \RArrow ~ \varname{result}\\
\code{decf} \varname{place} \code{\&optional} \varname{d} \RArrow ~ \varname{result}

\DArgsNValues{}

\varname{d} -- A \clterm{number}, the default is \code{1}.\\
\varname{result} -- A \clterm{number}.\\
\varname{place} -- A \CL{} \clterm{place}.\\


\DDescription{}

The macros \code{incf} and \code{decf} behave
as the \CL{} counterparts on non-\clieeeterm{NaN}s and
non-\clieeeterm{infinities} (see \cite{1996:ANSIHyperSpec}).

The macros \code{incf} and \code{decf} return a \clieeeterm{quiet NaN}
as \varname{result} when \varname{place} or \varname{d} is a
\clieeeterm{quiet NaN}; they return an \clieeeterm{infinity} equal to
\varname{n}, when \varname{n} is an \clieeeterm{infinity}.

\DExceptional{}

The conditions signaled are those described for \code{+} and \code{-}.

\DNotes{}

The default for \varname{d} is coerced to the appropriate floating
point \code{1.0}, depending on the floating point format of
\varname{place}.

\DSeeAlso{}

\code{+}, \code{-}, \code{1+}, \code{1-}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{conjugate}}
\index{C!\code{conjugate}}

\DSyntax{}

\code{conjugate} \varname{n} \RArrow{} \varname{c}

\DArgsNValues{}

\varname{n}, \varname{c} -- \CL{} \clterm{number}s.

\DDescription{}

The function \code{conjugate} behaves like the corresponding
\code{cl:conjugate} function, when \varname{n} is a \clterm{real}
number that is not a \clieeeterm{NaN}.

\noindent
When \varname{n} is a \clieeeterm{quiet NaN} then \varname{c} is a
\clieeeterm{quiet NaN}.

\DExceptional{}

When \varname{n} is a \clieeeterm{signaling NaN} then the
\clname{cl:floating-point-invalid-operation} error is signaled.

When \varname{n} is a \clterm{complex number}, then \code{conjugate}
can signal the same set of conditions as if computing
\code{(- (cl:imagpart} \varname{n}\code{))} while constricting the result
\varname{c}.

The function \code{conjugate} signals a \code{type-error} if
\varname{n} is not a \clterm{number}.


\DSeeAlso{}

\code{-}.


\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Exponential, Logarithms and Trigonometry Operations}
\label{sect:transc-ops}

\begin{tt}
  \begin{tabular}{lll}
    \#| abs |\# & cos & signum\\
    acos &  cosh &  sin\\
    acosh & exp  &  sinh\\
    asin &  expt &  sqrt\\
    asinh & isqrt &  tan\\
    atan &  log &   tanh\\
    atanh & phase & \\
    cis & \#| pi |\# & \\
  \end{tabular}
\end{tt}

\vspace*{3mm}

\noindent
The above table corresponds to Figure~12-2 of \cite{1996:ANSIHyperSpec}.
The ``commented'' entries will not be described as they either don't
operate on floating point numbers or do not have a semantic different
from the \CL{} standard.

\noindent
The listed \CL{} functions have correspondences in the \cite{2008:IEEE-754}
specification, but with some key differences, e.g., \code{cl:log} returns
a \clterm{complex number} for negative values.  In the following each
function will be further specified to comply with the \cite{2008:IEEE-754}
standard.

\vspace*{3mm}

The following functions will also be specified for completeness,
according to Section~9 of \cite{2008:IEEE-754}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{asin}, \code{acos}, \code{atan}}
\index{A!\code{asin}}
\index{A!\code{acos}}
\index{A!\code{atan}}

\DSyntax{}

\code{asin} \varname{n} \RArrow \varname{radians}\\
\code{acos} \varname{n} \RArrow \varname{radians}\\
\code{atan} \varname{n1} \code{\&optional} \varname{n2} \RArrow
\varname{radians}

\DArgsNValues{}

\varname{n}, \varname{n1}, \varname{n2} -- A \clieeeterm{floating
  point number}\\
\varname{radians} -- A \clieeeterm{floating point number}

\DDescription{}

The functions \code{asin}, \code{acos}, \code{atan} compute the the
arc sine, arc cosine and arc tangent of a number.  Their behavior is
the one described in \cite{1996:ANSIHyperSpec} for regular floating point
numbers.

The functions return a \clieeeterm{quiet NaN} if \varname{n},
\varname{n1}, or \varname{n2} is a \clieeeterm{quiet NaN}.

The behavior of \code{asin}, \code{acos}, and \code{atan} in case of
\clterm{complex} arguments is also the one described in
\cite{1996:ANSIHyperSpec}.

\DNotes{}

The functions \code{asin} and \code{acos} do not signal a
\code{cl:floating-point-invalid-operation} when \varname{n} is a
\clterm{real} outside the $[-1, 1]$ interval; they quietly return a
\clterm{complex} number.

\DExceptional{}

If \varname{n}, \varname{n1}, or \varname{n2} is a
\clieeeterm{signaling NaN}, then \code{asin}, \code{acos} and
\code{atan} signal the\\
\clname{cl:floating-point-invalid-operation} error.

According to \cite{2008:IEEE-754} there are several issues to be
considered.

If \varname{n}, \varname{n1}, or \varname{n2} are not \clterm{number}s
a \code{type-error} is signaled by \code{acos}, \code{asin}, and
\code{atan}.  If \varname{n1} and \varname{n2} are both supplied to
\code{atan}, and they are not both \clterm{real} numbers, then a
\code{type-error} is signaled.


\newpage

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection*{Numeric Comparison and Predicates}

\begin{tt}
  \begin{tabular}{lll}
    /= &  >=     & oddp\\
    <  &  evenp  & plusp\\
    <= &  max    & zerop\\
    =  &  min    & \\
    >  &  minusp & \\
  \end{tabular}
\end{tt}

\noindent
The table above corresponds to Figure~12-3 of
\cite{1996:ANSIHyperSpec}.  The LIA specifications require more
operators than those listed above.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{=}, \code{/=}}
\index{*!\code{=}}
\index{*!\code{/=}}

\DSyntax{}

\code{=} \varname{a}, \varname{b} \RArrow \varname{boolean}\\
\code{=} \varname{a} \code{\&rest} \varname{bs} \RArrow \varname{boolean}\\
\code{/=} \varname{a}, \varname{b} \RArrow \varname{boolean}\\
\code{/=} \varname{a} \code{\&rest} \varname{bs} \RArrow \varname{boolean}

\DArgsNValues{}

\varname{a} \varname{b} -- Numbers.\\
\varname{bs} -- A list of numbers.\\
\varname{boolean} -- a \clterm{generalized boolean}.

\DDescription{}

The dyadic version of \code{=} (and \code{/=}) performs an arithmetic
equality (inequality) test between \varname{a} and \varname{b}.  The
monadic and n-adic versions are built upon the dyadic one as per the
regular \CL{} description in \cite{1996:ANSIHyperSpec}.

It is assumed that \varname{a} and \varname{b} are converted (as per
the \emph{contagion rules} of \CL{}) to be of the same type.
Therefore the following cases can be be considered as per the LIA
specifications.

\begin{description}
\item If \varname{a} and \varname{b} are either finite integers, finite
floating point numbers, or finite complex numbers then the result is
\varname{true} (respectively, \varname{false}) if the two numbers are
equal (respectively, different) in the mathematical sense.  In the
LIA spec this is the result of $\mathit{eq}_T(a, b) \equiv a = b$ or
$\mathit{neq}_T(a, b) \equiv a \neq b$ for an
appropriate $T$.  This is the standard \CL{} case.

\item If \varname {a} and \varname {b} are \clieeeterm{infinities} then
\code{=} returns \varname{true} (respectively \varname{false}) if they
are both positive or both negative; otherwise it returns
\varname{false} (respectively \varname{true}).

\item If either \varname {a} or \varname {b} is a \clieeeterm{quiet NaN},
and, respectively, \varname {b} and \varname {a} is not a
\clieeeterm{signaling NaN}, then the result is \varname{false}.

\item Complex numbers are checked recursively on the real and imaginary
parts.
\end{description}

\DExceptional{}

If either \varname {a} or \varname {b} is a \clieeeterm{signaling
  NaN}, then, under the notification NACF regime, the indicator
\code{:invalid} is recorded and the
\code{floating-point-invalid-operation} is signaled (with
\emph{continuation value} \code{NIL} recorded); otherwise, under the
NRI notification regime, the indicator \code{invalid} is recorded and
\code{NIL} (\varname{false}) is returned as \emph{continuation value}.

For complex numbers, the recording and signaling operations (under NRI
and NACF) happens if the condition above applied to either of the real
or the imaginary parts of \varname{a} and \varname{b}.


% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \DDictionaryItem{Function \code{=}}
% \index{*!\code{=}}

% \DSyntax{}

% \code{=} \varname{a}, \varname{b} \RArrow \varname{boolean}\\
% \code{=} \varname{a} \code{\&rest} \varname{bs} \RArrow \varname{boolean}

% \DArgsNValues{}

% \varname{a} \varname{b} -- Numbers.\\
% \varname{bs} -- A list of numbers.\\
% \varname{boolean} -- a \clterm{generalized boolean}.

% \DDescription{}

% The dyadic version of \code{=} performs an arthimetic equality test
% between \varname{a} and \varname{b}.  The monadic and n-adic versions are built upon
% the dyadic one as per the regular \CL{} description in
% \cite{1996:ANSIHyperSpec}.

% It is assumed that \varname{a} and \varname{b} are converted (as per
% the \emph{contagion rules} of \CL{}) to be of the same type.
% Therefore the following cases can be be considered as per the LIA
% specifications.

% \begin{description}
% \item If \varname{a} and \varname{b} are either finite integers, finite
% floating point numbers, or finite complex numbers then the result is
% \varname{true} if the two numbers are equal in the mathematical sense.  In the
% LIA spec this is the result of $\mathit{eq}_T(a, b) \equiv a = b$ for an
% appropriate $T$.  This is the standard \CL{} case.

% \item If \varname {a} and \varname {b} are \clieeeterm{infinities} then
% \code{=} returns \varname{true} if they are both positive or both
% negative; otherwise it returns \varname{false}.

% \item If either \varname {a} or \varname {b} is a \clieeeterm{quiet NaN},
% and, respectively, \varname {b} and \varname {a} is not a
% \clieeeterm{signaling NaN}, then the result is \varname{false}.

% \item Complex numbers are checked recursively on the real and imaginary
% parts.
% \end{description}

% \DExceptional{}

% If either \varname {a} or \varname {b} is a \clieeeterm{signaling
%   NaN}, then, under the notification NACF regime, the indicator
% \code{:invalid} is recorded and the
% \code{floating-point-invalid-operation} is signalled (with
% \emph{continuation value} \code{NIL} recorded); otherwise, under the
% NRI notification regine, the indicator \code{invalid} is recorded and
% \code{NIL} (\varname{false}) is returned as \emph{continuation value}.

% For complex numbers, the recording and signaling operations (under NRI
% and NACF) happens if the condition above applied to either of the real
% or the imaginary parts of \varname{a} and \varname{b}.


% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \DDictionaryItem{Function \code{/=}}
% \index{*!\code{/=}}

% \DSyntax{}

% \code{/=} \varname{a}, \varname{b} \RArrow \varname{boolean}\\
% \code{/=} \varname{a} \code{\&rest} \varname{bs} \RArrow \varname{boolean}

% \DArgsNValues{}

% \varname{a} \varname{b} -- Numbers.\\
% \varname{bs} -- A list of numbers.\\
% \varname{boolean} -- a \clterm{generalized boolean}.

% \DDescription{}

% The dyadic version of \code{/=} performs an arthimetic equality test
% between \varname{a} and \varname{b}.  The monadic and n-adic versions are built upon
% the dyadic one as per the regular \CL{} description in
% \cite{1996:ANSIHyperSpec}.

% It is assumed that \varname{a} and \varname{b} are converted (as per
% the \emph{contagion rules} of \CL{}) to be of the same type.
% Therefore the following cases can be be considered as per the LIA
% specifications.

% If \varname{a} and \varname{b} are either finite integers, finite
% floating point numbers, or finite complex numbers then the result is
% \varname{true} if the two numbers are equal in the mathematical sense.  In the
% LIA spec this is the result of $\mathit{neq}_T(a, b) \equiv a \neq b$ for an
% appropriate $T$.  This is the standard \CL{} case.

% If \varname {a} and \varname {b} are \clieeeterm{infinities} then
% \code{/=} returns \varname{false} if they are both positive or both
% negative; otherwise it returns \varname{true}.

% If either \varname {a} or \varname {b} is a \clieeeterm{quiet NaN},
% and, respectively, \varname {b} and \varname {a} is not a
% \clieeeterm{signaling NaN}, then the result is \varname{false}.

% Complex numbers are checked recursively on the real and imaginary parts.

% \DExceptional{}

% If either \varname {a} or \varname {b} is a \clieeeterm{signaling
%   NaN}, then, under the notification NACF regime, the indicator
% \code{:invalid} is recorded and the
% \code{floating-point-invalid-operation} is signalled (with
% \emph{continuation value} \code{NIL} recorded); otherwise, under the
% NRI notification regine, the indicator \code{invalid} is recorded and
% \code{NIL} (\varname{false}) is returned as \emph{continuation value}.

% For complex numbers, the recording and signaling operations (under NRI
% and NACF) happens if the condition above applied to either of the real
% or the imaginary parts of \varname{a} and \varname{b}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{<}, \code{<=}, \code{>}, \code{>=}}
\index{*!\code{<}}
\index{*!\code{<=}}
\index{*!\code{>}}
\index{*!\code{>=}}

\DSyntax{}

\code{<} \varname{a}, \varname{b} \RArrow \varname{boolean}\\
\code{<} \varname{a} \code{\&rest} \varname{bs} \RArrow \varname{boolean}\\
\code{<=} \varname{a}, \varname{b} \RArrow \varname{boolean}\\
\code{<=} \varname{a} \code{\&rest} \varname{bs} \RArrow \varname{boolean}\\
\code{>} \varname{a}, \varname{b} \RArrow \varname{boolean}\\
\code{>} \varname{a} \code{\&rest} \varname{bs} \RArrow \varname{boolean}\\
\code{>=} \varname{a}, \varname{b} \RArrow \varname{boolean}\\
\code{>=} \varname{a} \code{\&rest} \varname{bs} \RArrow \varname{boolean}

\DArgsNValues{}

\varname{a} \varname{b} -- Numbers.\\
\varname{bs} -- A list of numbers.\\
\varname{boolean} -- a \clterm{generalized boolean}.

\DDescription{}

The dyadic version of \code{<}, \code{<=}, \code{>} and \code{>=}
perform arithmetic ordering tests between \varname{a} and
\varname{b}.  The monadic and n-adic versions are built upon the
dyadic one as per the regular \CL{} description in
\cite{1996:ANSIHyperSpec}.

It is assumed that \varname{a} and \varname{b} are converted (as per
the \emph{contagion rules} of \CL{}) to be of the same type.
Therefore the following cases can be be considered as per the LIA
specifications.

\begin{description}
\item If \varname{a} and \varname{b} are either finite reals, then the result is
\varname{true} (respectively, \varname{false}) if \varname{a} is
less or less than or equal (respectively, greater or greater or equal)
than \varname{b} in the mathematical sense.  In the
LIA specification this is the result of
$\mathit{lss}_T(a, b) \equiv a < b$,
$\mathit{leq}_T(a, b) \equiv a \leq b$
$\mathit{gtr}_T(a, b) \equiv a > b$, or
$\mathit{geq}_T(a, b) \equiv a \geq b$
for an
appropriate $T$.  This is the standard \CL{} case.

\item If \varname {a} and \varname {b} are \clieeeterm{infinities} then
\code{=} returns \varname{true} (respectively \varname{false}) if they
are both positive or both negative; otherwise it returns
\varname{false} (respectively \varname{true}).

\item If either \varname {a} or \varname {b} is a \clieeeterm{quiet NaN},
and, respectively, \varname {b} and \varname {a} is not a
\clieeeterm{signaling NaN}, then the result is \varname{false}.

\item Complex numbers cannot be compared as per the \CL{}
  specification \cite{1996:ANSIHyperSpec}.
\end{description}

\DExceptional{}

If either \varname {a} or \varname {b} is a \clieeeterm{signaling
  NaN}, then, under the notification NACF regime, the indicator
\code{:invalid} is recorded and the
\code{floating-point-invalid-operation} is signaled (with
\emph{continuation value} \code{NIL} recorded); otherwise, under the
NRI notification regime, the indicator \code{invalid} is recorded and
\code{NIL} (\varname{false}) is returned as \emph{continuation value}.

If either \varname{a}, or \varname{b} is not a \clterm{real} then a
\code{type-error} is signaled.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{is-neg-zero}, \code{neg-zero-p}}
\index{I!\code{is-neg-zero}}
\index{N!\code{neg-zero-p}}


\DSyntax{}

\code{is-neg-zero} \varname{x} \RArrow \varname{boolean}\\
\code{neg-zero-p} \varname{x} \RArrow \varname{boolean}

\DArgsNValues{}

\varname{x} -- A \clterm{real}.\\
\varname{boolean} -- A \clterm{generalized boolean}.


\DDescription{}

These functions check whether \varname{x} is a \emph{negative zero}
(i.e., $-0$).  For \CL{} the value returned is constantly \clterm{false}
(i.e., \code{NIL}).

\DExceptional{}

If \varname{x} is a \clieeeterm{NaN} then, under NCAF regime, the
function signals a\\
\code{floating-point-invalid-operation} with a
\code{NIL} \clieeeterm{continuation value}; under NRI, the
\code{:invalid} indicator is recorded and the \clieeeterm{continuation
  value} \code{NIL} is returned.

The function signals a \code{type-error} if the argument \varname{x}
is not a \clterm{real}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{is-tiny}, \code{tiny-p}}
\index{I!\code{is-tiny}}
\index{T!\code{tiny-p}}


\DSyntax{}

\code{is-tiny} \varname{x} \RArrow \varname{boolean}\\
\code{tiny-p} \varname{x} \RArrow \varname{boolean}

\DArgsNValues{}

\varname{x} -- A \clterm{real}.\\
\varname{boolean} -- A \clterm{generalized boolean}.


\DDescription{}

These functions check whether \varname{x} is a \emph{tiny}
\clterm{real} close to  $0$.

\DExceptional{}

If \varname{x} is a \clieeeterm{NaN} then, under NCAF regime, the
function signals a\\
\code{floating-point-invalid-operation} with a
\code{NIL} \clieeeterm{continuation value}; under NRI, the
\code{:invalid} indicator is recorded and the \clieeeterm{continuation
  value} \code{NIL} is returned.

The function signals a \code{type-error} if the argument \varname{x}
is not a \clterm{real}.

\DNotes{}

It is very difficult to correctly specify the behavior of this function
in terms of \CL{} usual setup and assumptions.  Most implementations
may simply leave this \clliaterm{not-implemented}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{signum}, \code{float-sign}}
\index{S!\code{signum}}
\index{F!\code{float-sign}}


\DSyntax{}

\code{signum} \varname{x} \RArrow \varname{signed-prototype}\\
\code{float-sign} \varname{f1} \code{\&optional} \varname{f2}
\RArrow \varname{signed-float}


\DArgsNValues{}

\varname{x} -- a \clterm{number}\\
\varname{signed-prototype} -- a \clterm{number}\\
\varname{f1} -- a \clterm{float}\\
\varname{f2} -- a \clterm{float}\\
\varname{signed-float} -- a \clterm{float}


\DDescription{}

The functions \code{signum} and \code{float-sign} behave as per the
the \CL{} Standard \cite{1994:ANSICL} in the cases where the arguments
\varname{x}, \varname{f1} and \varname{f2} are as in the standard case.

The \code{signum} function returns $1$ if \varname{x} is a positive
\clliaterm{infinity}, and  $-1$ if \varname{x} is a negative
\clliaterm{infinity}.

If \varname{x} is a \clterm{complex} number, then the result
\varname{signed-prototype} is also a \clterm{complex number}, and its
value is determined according to the specification set forth in LIA3
\cite{2004:LIA3}.

If \varname{x} is a floating point \clliaterm{quiet NaN} then
\code{signum} returns a \clliaterm{quiet NaN}.

The function \code{float-sign} returns an \clliaterm{infinity} of the
appropriate sign if \varname{f2} is an \clliaterm{infinity}.  If
either \varname{f1} or \varname{f2} is a \clliaterm{quiet NaN} then
\code{float-sign} returns a \clliaterm{quiet NaN}.

\DExceptional{}

If \varname{x} is a floating point \clliaterm{signaling NaN} and the
notification style is NACF, then a\\
\code{floating-point-invalid} condition is signaled with a
\clliaterm{quiet NaN} as a \emph{continuation value}; if the
notification style is NRI then the indicator \code{:invalid} is
recorder and a \clliaterm{quiet NaN} is returned.

A \code{type-error} is signaled if \varname{x} is not a number or
either \varname{f1}, or \varname{f2} is not a \clterm{float} number.


\DNotes{}

The specification of \code{signum} is substantially different from the
one present in \cite{1994:ANSICL}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Function \code{residue}}
\index{R!\code{residue}}

\DSyntax{}

\code{residue} \varname{x} \varname {y} \RArrow \varname{rm}

\DArgsNValues{}

\varname{x} -- a \clterm{number}\\
\varname{y} -- a \clterm{number}\\
\varname{rm} -- a \clterm{number}


\DDescription{}

The \code{residue} function returns the \clliaterm{remainder}
\varname{rm} of a the division between \varname{x} and \varname{y}.

When \varname{y} is an \clliaterm{infinite} number, than \varname{rm}
is \varname{y} itself.  If either \varname{x} or \varname{y} is a
\clliaterm{quiet NaN} then \varname{rf} is a \clliaterm{quite NaN}.

If either \varname{x} or \varname{y} is a \clterm{complex number}
then, as per LIA3 \cite{2004:LIA3}, the real part and the imaginary
part must be \clterm{integer numbers} and the result \varname{rm} is
computed as per LIA3.


\DExceptional{}

If either \varname{x} or \varname{y} is a \clliaterm{signaling NaN}
then if the notification style is NACF then a\\
\code{floating-point-invalid-operation} is signaled with a
\clliaterm{quiet NaN} as continuation value.  If the notification
style is NRI then the \code{:invalid} indicator is recorded and a
\clliaterm{quiet NaN} is returned as continuation value.

A \code{type-error} is signaled if either \varname{x} or \varname{y} is
not a \clliaterm{number}.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{sqrt}, \code{sqrt.<>}, \code{sqrt.<},
  \code{sqrt.>}}
\index{S!\code{sqrt}}
\index{S!\code{sqrt.<>}}
\index{S!\code{sqrt.<}}
\index{S!\code{sqrt.>}}


\DSyntax{}

\code{sqrt} \varname{n} \RArrow{} \varname{root}\\
\code{sqrt.<>} \varname{n} \RArrow{} \varname{root}\\
\code{sqrt.<} \varname{n} \RArrow{} \varname{root}\\
\code{sqrt.>} \varname{n} \RArrow{} \varname{root}

\DArgsNValues{}

\varname{n} -- A \clterm{number}.\\
\varname{root} -- A \clterm{number}.

\DDescription{}

The functions, \code{sqrt}, \code{sqrt.<>}, \code{sqrt.<}, and
\code{sqrt.>} compute the \emph{square root} of \varname{n}.  They
behave like \code{cl:sqrt} on well behaved \varname{n} values.
\code{sqrt.<>} always computes \varname{root} rounding to nearest;
\code{sqrt.<} always computes \varname{root} rounding downward;
\code{sqrt.>} always computes \varname{root} rounding upward. Instead
\code{sqrt} computes \varname{root} according to the current rounding
mode.

If \varname{n} is a \clliaterm{quiet NaN} then \varname{root} is also
a \clliaterm{quiet NaN}.


\DExceptional{}

If \varname{} is a \clliaterm{signaling NaN} then if the notification
style is NACF then a\\
\code{floating-point-invalid-operation} is
signaled, with a \clliaterm{quiet NaN} as a continuation value.  If
the notification style is NRI then the \code{:invalid} indicator is
recorded and a \clliaterm{quiet NaN} is returned as continuation
value.


A \code{type-error} is signaled if \varname{n} is not a number

\DNotes{}

The LIA specification suggests to call \code{sqrt.<} and \code{sqrt.>}
as \code{sqrtDwn} and \code{sqrtUp} (cfr., LIA1
\cite{2012:LIA1}). This suggestion goes against the traditional \CL{}
naming verbosity ``feature'', plus it assumes case-sensitivity, which
\CL{} does not have in default mode.  Therefore the more evocative
names \code{sqrt.<} and \code{sqrt.>} (and \code{sqrt.<>}) are
introduced.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{exponent}, \code{fraction}}
\index{E!\code{exponent}}
\index{F!\code{fraction}}

\DSyntax{}

\code{exponent} \varname{f} \RArrow{} \varname{exp}\\
\code{fraction} \varname{f} \RArrow{} \varname{frac}\\


\DArgsNValues{}

\varname{f} -- A \clterm{float}.\\
\varname{exp} -- An \clterm{integer}.\\
\varname{frac} -- A \clterm{float}.

\DDescription{}

The \code{exponent} and \code{fraction} functions extract parts of the
representation of a floating point number.  The two functions behave
as if defined (for finite floating point numbers) as follows:

\begin{alltt}
  (defun \codelia{fraction} (f) (nth-value 1 (decode-float f)))
  
  (defun \codelia{exponent} (f) (nth-value 0 (decode-float f)))
  
  \textcolor{red}{;;; NTH-VALUE is used in both functions just for symmetry.}
\end{alltt}

If \varname{f} is an \clliaterm{infinity} or $0$, then \code{fraction}
returns \varname{f} as result \varname{frac}; \code{exponent}
returns $\infty$ if \varname{f} is an \clliaterm{infinity}.

If \varname{f} is a \clliaterm{quiet NaN} then, \code{exponent}
returns a \clliaterm{quiet NaN}.  If \varname{f} is a \clliaterm{quiet
  NaN} then, \code{exponentfraction} returns a \clliaterm{quiet NaN}.

\DExceptional{}

If \varname{f} is a \clliaterm{signaling NaN} then, if the notification
style is NACF, the condition\\
\code{floating-point-invalid-operation} is signaled with a
\clliaterm{quiet NaN} as continuation value; if the notification style
is NRI, the indicator \code{:invalid} is recorded and a
\clliaterm{quiet NaN} is returned as continuation value.

If \varname{f} is $0$ then \code{exponent} signals a
\code{floating-point-infinitary-operation} with a negative
\clliaterm{infinite} ($-\infty$) as continuation value If the
notification style is NACF; otherwise, if the notification style is
NRI, the \code{:infinitary} indicator is recorded and a negative
\clliaterm{infinite} ($-\infty$) is returned as continuation value.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Functions \code{scale-float}}
\index{S!\code{scale-float}}

\DSyntax{}

\code{scale-float} \varname{f} \varname{k} \RArrow{} \varname{scaled-float}


\DArgsNValues{}

\varname{f} -- A \clterm{float}.\\
\varname{k} -- An \clterm{integer}.\\
\varname{scaled-float} -- A \clterm{float}.


\DDescription{}

The function \code{scale-float} behaves like \code{cl:scale-float} for
well behaved \varname{f} and \varname{k}.




% \vspace*{3mm}

% \noindent
% Note that the \code{evenp} and \code{oddp} functions are not present
% in the above table,  which corresponds to Figure~12-3 of
% \cite{1996:ANSIHyperSpec}.

% \paragraph{Correspondances with \IEEEFPStd{}.} The list of operations
% recommended by \cite{2008:IEEE-754} is more extensive than the list of
% operations provided by \CL{} (cfr., Table~9.1 in \cite{2008:IEEE-754}).
% The tables referenced below provide correspondances for the \CL{} functions,
% especially regarding the exceptions (conditions) that must be
% signalled.

% \begin{table}[h]
%   \begin{tabulary}{\textwidth}{|L|L|L|}
%     \hline
%     \CL{} Function & IEEE-745 Function & Exceptional Situations\\
%     \hline\hline
%     \multicolumn{3}{|l|}{Arithmetic}\\\hline
%     \code{+}
%     & \textit{F\_\textbf{addition}}(\varname{a}, \varname{b})
%     & Long list of cases
%     \\\hline
    
%   \end{tabulary}
% \end{table}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\DDictionaryItem{Error \code{ieee-754-not-implemented-item}}
\index{I!\code{ieee-754-not-implemented-item}}

\DSupertypes{}

\code{ieee-754-not-implemented-item}, \code{error},
\code{cl:arithmetic-error}, \ldots, \code{T}

\DDescription{}

This error is signaled by functions and macros that do not have (yet)
an implementation in the running \CL{} at hand.


\newpage

\nocite{2012:LIA1,2001:LIA2,2004:LIA3}
\nocite{1994:ANSICL}

\bibliographystyle{plain}
\bibliography{CDR-CL-LIA}

% \begin{thebibliography}{9}

% \bibitem{IEEE-754}
%   \textit{{IEEE} Standard for Floating-Point Arithmetic}, IEEE Std
%   754$^{\mathrm{tm}}$-2008, IEEE Computer Society, 2008.
  
% \bibitem{C18}
%   \textit{Programming languages -- C},
%   International Standard \emph{ISO/IEC 9899-2018}, 2018.
  
% \bibitem{ANSIHyperSpec}
%   \textit{The \CL{} Hyperspec},
%   published online at\\
%   \texttt{http://www.lisp.org/HyperSpec/FrontMatter/index.html}, 1994.

% \end{thebibliography}


\appendix

\section{Example Programs}

This section corresponds to Annex~F of \cite{2012:LIA1}.  The programs
are \CL{} renditions of the programs listed there.  Note that some of
the programs are writable in standard \CL{}.

\subsection{Verifying Platform Acceptability}

Suppose some code should be executed only is the single float
precision is at least 1 part in a million.  The code below can be used
to bail out before executing it.
\begin{alltt}
    (when (< (/ single-float-epsilon) 1.0e6)
        (format *error-output*
                "The SINGLE-FLOAT type has insufficient precision.")
        (abort 'arithmetic-error))
    ...
\end{alltt}

\noindent
A range test on the bounds of the single float type.
\begin{alltt}
    (when (or (< most-positive-single-float 1.0e30)
              (> least-positive-single-float 1.0e-10))
        ...)
\end{alltt}

\noindent
Checking for $\frac{1}{2}$ulp.
\begin{alltt}
    (when (/= \codelia{single-float-rounding-error} 0.5) ...)
\end{alltt}

\noindent
Conditional execution of code depending on conformance can be done in
two ways.
\begin{alltt}
    #+ieee-floating-point 
    (some-code) 
\end{alltt}
or\ldots
\begin{alltt}
    (when (\codelia{ieee-floating-point}) \textbf{CHECK THIS WRT SPEC ABOVE!}
        (some-code))
\end{alltt}


\subsection{Selecting Alternative Code}

Being able to control rounding can be useful.
\begin{alltt}
    (cond ((\codelia{iec-559}) \textbf{CHECK THIS WRT SPEC ABOVE!}
           (\codelia{round-upward} 
              \textit{\ldots calc})
           (\codelia{round-downward}
              \textit{\ldots calc})
           (\codelia{round-to-nearest}
              \textit{\ldots calc})
           )
          (t
           \textit{\ldots calc}))
\end{alltt}

\subsection{Terminating a Loop}

\begin{alltt}
    (defconstant n 6.0s0) \textcolor{red}{; Max ulp difference for loop termination.}

    (loop for prev-approx of type single-float
          = (first-guess <\textit{input}>)
          then approx

          for approx of type single-float
          = (next-quess <\textit{input}> prev-approx)

          while (> (abs (- approx prev-approx))
                   (* n (\codelia{ulp} approx)))
          finally (return approx))
\end{alltt}


\subsection{Estimating Error}

\begin{alltt}
    (let ((a (make-array 100 :element-type 'double-float))
          (b (make-array 100 :element-type 'double-float))
          (dot 0.0d0)
          (dotmax 0.0d0)
          (loss 0)
         )
      (declare (type (array 100 double-float) a b)
               (type double-float dot dotmax)
               (type integer loss))
     
      (dotimes (i 100)
         (incf dot (* (aref a i) (aref b i)))
         (setf dotmax (max (abs dot) dotmax)))

      (setf loss (- (nth-value 1 (decode-float dotmax)) \textcolor{red}{; `exponent'.}
                    (nth-value 1 (decode-float dot))))
      (when (> loss (/ (float-digits dot) 2))
         (warn "Half the precision may be lost."))
      )
\end{alltt}


\subsection{Saving Exception State}

This is easy given the macros defined in the document.  There are a
few ways of doing this.

\begin{alltt}
    (\codelia{trap-math} (\codelia{:before (:save :clear)}
                \codelia{:after :merge})
       \textit{\ldots run desired code \ldots}
       \textit{\ldots examine indicators \ldots}
       \textit{\ldots clear some indicators \ldots}
       )
\end{alltt}
or\ldots
\begin{alltt}
    (let ((saved-flags (\codelia{fpe-test-notifications +fpe-all-notifications+})))
       (unwind-protect
           (progn (\codelia{fpe-clear-exceptions-flags +fpe-all-notifications+})
                  \textit{\ldots run desired code \ldots}
                  \textit{\ldots examine indicators \ldots}
                  \textit{\ldots clear some indicators \ldots}
                  )
         (\codelia{fpe-raise-exceptions-flags} saved-flags)))
\end{alltt}


\subsection{Fast versus Accurate}

\begin{alltt}
    (\codelia{trap-math} (\codelia{:before (:save :clear)}
                \codelia{:after :merge})
      (fast-solution input)
      (cl:floating-point-overflow ()
         \codelia{:clear}
         (\codelia{:continue} (reliable-solution input)))
      )
\end{alltt}


\subsection{High Precision Multiply}

\begin{alltt}
    (let* ((x1 (\codelia{round-float} x (/ (float-digits x) 2)))
           (x2 (- x x1))
           (y1 (\codelia{round-float} y (/ (float-digits y) 2)))
           (y2 (- y y2))
           \ldots
           )
      (declare (type double-float x1 x2 y1 y2 \ldots))

      \ldots
      )
\end{alltt}

\section{Copying and License}

This work may be distributed and/or modified under the conditions of
the \emph{LaTeX Project Public License} (LPPL), either version 1.3 of
this license or (at your option) any later version. The latest version
of this license is in \texttt{http://www.latex-project.org/lppl.txt}
and version 1.3 or later is part of all distributions of LaTeX version
2005/12/01 or later.

\noindent
This work has the LPPL maintenance status `maintained'.

\noindent
The Current Maintainer of this work is Marco Antoniotti.

\printindex

\end{document}

%%%% end of file --CDR-IEEE-754-support.tex --
